<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="description"
        content="The Hermetic Codex: A rational guide to ancient wisdom and modern logic. Explore the 7 Hermetic Principles, Mental Transmutation, and the Emerald Tablet.">
    <meta name="theme-color" content="#292524">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>The Hermetic Codex: A Rational Guide</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ===== CSS CUSTOM PROPERTIES FOR THEMING ===== */
        :root {
            /* Light Mode Colors */
            --bg-primary: #f5f5f0;
            --bg-secondary: #ffffff;
            --bg-tertiary: #fafaf9;
            --bg-nav: rgba(245, 245, 240, 0.95);
            --bg-card-dark: #292524;

            --text-primary: #292524;
            --text-secondary: #57534e;
            --text-muted: #78716c;
            --text-light: #a8a29e;

            --border-primary: #d6d3d1;
            --border-secondary: #e7e5e4;

            --accent-gold: #d69e2e;
            --accent-gold-bright: #f6e05e;
            --accent-amber: #b45309;

            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-glow: 0 0 20px rgba(214, 158, 46, 0.15);

            --transition-base: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* Dark Mode Colors */
        .dark {
            --bg-primary: #0c0a09;
            --bg-secondary: #1c1917;
            --bg-tertiary: #292524;
            --bg-nav: rgba(12, 10, 9, 0.95);
            --bg-card-dark: #1c1917;

            --text-primary: #fafaf9;
            --text-secondary: #d6d3d1;
            --text-muted: #a8a29e;
            --text-light: #78716c;

            --border-primary: #44403c;
            --border-secondary: #292524;

            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
            --shadow-glow: 0 0 30px rgba(214, 158, 46, 0.2);
        }

        * {
            -webkit-tap-highlight-color: transparent;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            transition: background-color var(--transition-base), color var(--transition-base);
        }

        .serif-header {
            font-family: 'Cormorant Garamond', 'Georgia', 'Times New Roman', serif;
        }

        /* ===== DARK MODE BUTTON ===== */
        .theme-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            background: var(--bg-secondary);
            border-radius: 12px;
            cursor: pointer;
            transition: all var(--transition-base);
            border: 2px solid var(--border-primary);
        }

        .theme-toggle:hover {
            border-color: var(--accent-gold);
            box-shadow: var(--shadow-glow);
            transform: scale(1.05);
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        .theme-toggle .sun-icon,
        .theme-toggle .moon-icon {
            width: 22px;
            height: 22px;
            transition: all var(--transition-bounce);
        }

        /* Light mode: show sun, hide moon */
        .theme-toggle .sun-icon {
            display: block;
        }

        .theme-toggle .moon-icon {
            display: none;
        }

        /* Dark mode: show moon, hide sun */
        .dark .theme-toggle .sun-icon {
            display: none;
        }

        .dark .theme-toggle .moon-icon {
            display: block;
        }

        /* Chart Container - Mobile First */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 250px;
        }

        @media (min-width: 640px) {
            .chart-container {
                height: 300px;
            }
        }

        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }

        /* ===== ENHANCED CARD ANIMATIONS ===== */
        .principle-card {
            transition: all var(--transition-base);
            background-color: var(--bg-secondary);
            border-color: var(--border-secondary);
            position: relative;
            overflow: hidden;
        }

        .principle-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(214, 158, 46, 0.05), transparent);
            transition: left 0.6s ease;
        }

        @media (hover: hover) {
            .principle-card:hover {
                transform: translateY(-4px) scale(1.01);
                box-shadow: var(--shadow-lg), var(--shadow-glow);
                border-color: var(--accent-gold);
            }

            .principle-card:hover::before {
                left: 100%;
            }
        }

        .principle-card:active {
            transform: scale(0.98);
        }

        /* ===== CATEGORY FILTER BUTTONS ===== */
        .category-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-secondary);
            color: var(--text-secondary);
            box-shadow:
                3px 3px 6px rgba(0, 0, 0, 0.1),
                -3px -3px 6px rgba(255, 255, 255, 0.7);
        }

        .dark .category-btn {
            box-shadow:
                3px 3px 6px rgba(0, 0, 0, 0.3),
                -3px -3px 6px rgba(255, 255, 255, 0.05);
        }

        .category-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        .category-btn.active {
            background: linear-gradient(135deg, #d69e2e, #b45309);
            color: white;
            border-color: transparent;
            box-shadow:
                inset 2px 2px 4px rgba(0, 0, 0, 0.2),
                0 4px 12px rgba(214, 158, 46, 0.3);
        }

        /* ===== LIBRARY CARD STYLES ===== */
        .library-card {
            background: var(--bg-secondary);
        }

        .library-card:hover {
            box-shadow: var(--shadow-lg), var(--shadow-glow);
            border-color: var(--accent-gold);
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* ===== SCROLL REVEAL ANIMATIONS ===== */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .reveal {
            opacity: 0;
        }

        .reveal.revealed {
            animation: slideUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        .reveal-delay-1 {
            animation-delay: 0.1s;
        }

        .reveal-delay-2 {
            animation-delay: 0.2s;
        }

        .reveal-delay-3 {
            animation-delay: 0.3s;
        }

        .reveal-delay-4 {
            animation-delay: 0.4s;
        }

        .reveal-delay-5 {
            animation-delay: 0.5s;
        }

        .reveal-delay-6 {
            animation-delay: 0.6s;
        }

        .reveal-delay-7 {
            animation-delay: 0.7s;
        }

        /* ===== FLOATING PARTICLES BACKGROUND ===== */
        .particles-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--accent-gold);
            border-radius: 50%;
            opacity: 0;
            animation: float 20s infinite;
        }

        @keyframes float {

            0%,
            100% {
                opacity: 0;
                transform: translateY(100vh) scale(0);
            }

            10% {
                opacity: 0.3;
            }

            50% {
                opacity: 0.15;
            }

            90% {
                opacity: 0.3;
            }

            100% {
                opacity: 0;
                transform: translateY(-10vh) scale(1);
            }
        }

        /* Custom Scrollbar with theming */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: var(--border-secondary);
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: var(--text-light);
            border-radius: 3px;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-light);
        }

        /* Mobile-friendly touch targets */
        .touch-target {
            min-height: 44px;
            min-width: 44px;
        }

        /* Range input styling for mobile - with theming */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            width: 100%;
        }

        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            background: var(--border-primary);
            border-radius: 4px;
            transition: background var(--transition-base);
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: var(--accent-gold);
            cursor: pointer;
            margin-top: -8px;
            box-shadow: var(--shadow-md);
            transition: transform var(--transition-bounce), box-shadow var(--transition-base);
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.15);
            box-shadow: var(--shadow-glow);
        }

        input[type="range"]::-moz-range-track {
            width: 100%;
            height: 8px;
            background: var(--border-primary);
            border-radius: 4px;
        }

        input[type="range"]::-moz-range-thumb {
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: var(--accent-gold);
            cursor: pointer;
            border: none;
            box-shadow: var(--shadow-md);
        }

        /* Polarity buttons - with theming */
        .polarity-buttons {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
            padding-bottom: 0.5rem;
        }

        .polarity-buttons::-webkit-scrollbar {
            display: none;
        }

        .polarity-btn {
            flex-shrink: 0;
            padding: 0.75rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all var(--transition-bounce);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .polarity-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent);
            opacity: 0;
            transition: opacity var(--transition-base);
        }

        .polarity-btn:hover::before {
            opacity: 1;
        }

        .polarity-btn.active {
            background: var(--accent-gold);
            color: var(--bg-primary);
            border-color: var(--accent-gold);
            box-shadow: 0 0 20px rgba(214, 158, 46, 0.3);
            transform: scale(1.02);
        }

        .polarity-btn:not(.active) {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-color: var(--border-primary);
        }

        .polarity-btn:not(.active):hover {
            border-color: var(--accent-gold);
            transform: translateY(-2px);
        }

        /* Mobile menu animation - enhanced */
        #mobile-menu {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 0;
            overflow: hidden;
            background: var(--bg-tertiary);
        }

        #mobile-menu.open {
            max-height: 400px;
        }

        /* Hamburger animation - enhanced */
        .hamburger {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            width: 28px;
            height: 24px;
            cursor: pointer;
            padding: 4px;
        }

        .hamburger span {
            display: block;
            width: 100%;
            height: 2px;
            background: var(--text-secondary);
            border-radius: 2px;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .hamburger.open span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .hamburger.open span:nth-child(2) {
            opacity: 0;
            transform: scaleX(0);
        }

        .hamburger.open span:nth-child(3) {
            transform: rotate(-45deg) translate(5px, -5px);
        }

        /* Tablet card - with theming and animations */
        .tablet-card {
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .tablet-card::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, transparent 40%, rgba(214, 158, 46, 0.1) 100%);
            opacity: 0;
            transition: opacity var(--transition-base);
        }

        .tablet-card:hover::after {
            opacity: 1;
        }

        .tablet-card:active {
            transform: scale(0.98);
        }

        /* Assessment labels - with theming */
        .assessment-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-secondary);
            transition: background var(--transition-base);
        }

        .assessment-item:last-child {
            border-bottom: none;
        }

        .assessment-item:hover {
            background: var(--bg-tertiary);
            margin: 0 -0.5rem;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
            border-radius: 8px;
        }

        @media (min-width: 640px) {
            .assessment-item {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }

        /* ===== GOLD SHIMMER EFFECT - ENHANCED ===== */
        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        .gold-accent {
            background: linear-gradient(90deg, var(--accent-gold), var(--accent-gold-bright), var(--accent-gold));
            background-size: 200% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: shimmer 3s ease-in-out infinite;
        }

        /* ===== PULSE GLOW ANIMATION ===== */
        @keyframes pulseGlow {

            0%,
            100% {
                box-shadow: 0 0 5px rgba(214, 158, 46, 0.2);
            }

            50% {
                box-shadow: 0 0 20px rgba(214, 158, 46, 0.4);
            }
        }

        .pulse-glow {
            animation: pulseGlow 3s ease-in-out infinite;
        }

        /* ===== FLOATING H LOGO ===== */
        .hermetic-logo {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--accent-gold);
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            border-radius: 12px;
            border: 2px solid var(--accent-gold);
            box-shadow:
                0 0 20px rgba(214, 158, 46, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            animation: logoFloat 3s ease-in-out infinite, logoGlow 2s ease-in-out infinite alternate;
            cursor: pointer;
            transition: transform var(--transition-bounce), box-shadow var(--transition-base);
        }

        .hermetic-logo:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow:
                0 0 30px rgba(214, 158, 46, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .hermetic-logo::before {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 14px;
            background: linear-gradient(135deg, var(--accent-gold), transparent, var(--accent-gold));
            z-index: -1;
            opacity: 0.5;
            animation: logoBorderRotate 4s linear infinite;
        }

        @keyframes logoFloat {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-3px);
            }
        }

        @keyframes logoGlow {
            0% {
                box-shadow: 0 0 15px rgba(214, 158, 46, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            }

            100% {
                box-shadow: 0 0 25px rgba(214, 158, 46, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            }
        }

        @keyframes logoBorderRotate {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* ===== ALCHEMY DIAL ===== */
        .alchemy-dial-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .alchemy-dial {
            position: relative;
            width: 220px;
            height: 220px;
            border-radius: 50%;
            background: linear-gradient(145deg, var(--bg-tertiary), var(--bg-secondary));
            box-shadow:
                8px 8px 20px rgba(0, 0, 0, 0.2),
                -8px -8px 20px rgba(255, 255, 255, 0.05),
                inset 0 0 30px rgba(0, 0, 0, 0.1);
            border: 3px solid var(--border-primary);
            cursor: grab;
            touch-action: none;
            user-select: none;
        }

        .alchemy-dial:active {
            cursor: grabbing;
        }

        .alchemy-dial::before {
            content: '';
            position: absolute;
            inset: 8px;
            border-radius: 50%;
            background: conic-gradient(from 180deg,
                    #44403c 0deg,
                    #78716c 90deg,
                    #d69e2e 180deg,
                    #f6e05e 270deg,
                    #d69e2e 360deg);
            opacity: 0.2;
        }

        .dial-markers {
            position: absolute;
            inset: 0;
            border-radius: 50%;
        }

        .dial-marker {
            position: absolute;
            width: 2px;
            height: 12px;
            background: var(--text-muted);
            left: 50%;
            top: 8px;
            transform-origin: 50% 102px;
        }

        .dial-marker.major {
            height: 18px;
            width: 3px;
            background: var(--accent-gold);
        }

        .dial-knob {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 60px;
            height: 60px;
            margin: -30px 0 0 -30px;
            border-radius: 50%;
            background: linear-gradient(145deg, var(--bg-secondary), var(--bg-primary));
            box-shadow:
                4px 4px 10px rgba(0, 0, 0, 0.3),
                -2px -2px 8px rgba(255, 255, 255, 0.05);
            border: 2px solid var(--border-primary);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dial-knob::after {
            content: '☿';
            font-size: 1.5rem;
            color: var(--accent-gold);
        }

        .dial-pointer {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 70px;
            background: linear-gradient(to top, var(--accent-gold), var(--accent-gold-bright));
            transform-origin: 50% 100%;
            margin-left: -2px;
            margin-top: -70px;
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(214, 158, 46, 0.5);
            transition: transform 0.1s ease-out;
        }

        .dial-pointer::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -6px;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 12px solid var(--accent-gold-bright);
        }

        .dial-labels {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }

        .dial-label {
            position: absolute;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .dial-label.negative {
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: var(--text-muted);
        }

        .dial-label.positive {
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: var(--accent-gold);
        }

        .dial-value-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .dial-value {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: 'Cormorant Garamond', serif;
            background: linear-gradient(135deg, var(--text-muted), var(--accent-gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            transition: all 0.3s ease;
        }

        .dial-value.transmuted {
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-gold-bright));
            -webkit-background-clip: text;
            background-clip: text;
        }

        .dial-state-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }

        .dial-state-label.transmuted {
            color: var(--accent-gold);
        }

        .transmutation-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
            font-style: italic;
        }

        /* Subtle fade-in animation - enhanced */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        /* ===== HERO SECTION GRADIENT - ENHANCED ===== */
        .hero-gradient {
            background: radial-gradient(ellipse at top, rgba(214, 158, 46, 0.12) 0%, transparent 50%);
            position: relative;
        }

        .dark .hero-gradient {
            background: radial-gradient(ellipse at top, rgba(214, 158, 46, 0.08) 0%, transparent 50%);
        }

        /* ===== ACCENT LINE ANIMATION ===== */
        @keyframes expandLine {
            from {
                width: 0;
                opacity: 0;
            }

            to {
                width: 6rem;
                opacity: 1;
            }
        }

        .accent-line {
            animation: expandLine 1s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            animation-delay: 0.5s;
            width: 0;
        }

        /* ===== BUTTON RIPPLE EFFECT ===== */
        .ripple {
            position: relative;
            overflow: hidden;
        }

        .ripple::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(214, 158, 46, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease, opacity 0.6s ease;
            opacity: 0;
        }

        .ripple:active::after {
            width: 200%;
            height: 200%;
            opacity: 0;
        }

        /* ===== NAV LINKS HOVER ANIMATION ===== */
        .nav-link {
            position: relative;
            transition: color var(--transition-base);
        }

        .nav-link::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            width: 0;
            height: 2px;
            background: var(--accent-gold);
            transition: width var(--transition-base), left var(--transition-base);
            border-radius: 1px;
        }

        .nav-link:hover::after {
            width: 100%;
            left: 0;
        }

        /* ===== DETAIL PANEL ANIMATION ===== */
        #principle-detail {
            transform-origin: top;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #principle-detail:not(.hidden) {
            animation: scaleIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        /* ===== THEMED BACKGROUNDS ===== */
        .bg-themed {
            background-color: var(--bg-secondary);
            transition: background-color var(--transition-base);
        }

        .bg-themed-tertiary {
            background-color: var(--bg-tertiary);
            transition: background-color var(--transition-base);
        }

        .border-themed {
            border-color: var(--border-secondary);
            transition: border-color var(--transition-base);
        }

        .text-themed {
            color: var(--text-primary);
            transition: color var(--transition-base);
        }

        .text-themed-secondary {
            color: var(--text-secondary);
            transition: color var(--transition-base);
        }

        .text-themed-muted {
            color: var(--text-muted);
            transition: color var(--transition-base);
        }

        /* ===== SELECTION STYLING ===== */
        ::selection {
            background: rgba(214, 158, 46, 0.3);
            color: var(--text-primary);
        }

        /* ===== FOCUS STATES ===== */
        button:focus-visible,
        a:focus-visible,
        input:focus-visible {
            outline: 2px solid var(--accent-gold);
            outline-offset: 2px;
        }

        /* ===== DAILY ALIGNMENT RITUAL ===== */
        .ritual-card {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            border: 1px solid var(--border-primary);
            position: relative;
            overflow: hidden;
        }

        .ritual-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(214, 158, 46, 0.03), transparent 30%);
            animation: rotateGlow 20s linear infinite;
        }

        @keyframes rotateGlow {
            to {
                transform: rotate(360deg);
            }
        }

        .planetary-symbol {
            font-size: 3rem;
            line-height: 1;
            filter: drop-shadow(0 0 10px rgba(214, 158, 46, 0.3));
        }

        .moon-phase-icon {
            font-size: 2rem;
            animation: moonPulse 4s ease-in-out infinite;
        }

        @keyframes moonPulse {

            0%,
            100% {
                opacity: 0.7;
                transform: scale(1);
            }

            50% {
                opacity: 1;
                transform: scale(1.05);
            }
        }

        .breath-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px solid var(--accent-gold);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin: 0 auto;
        }

        .breath-circle::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 3px solid transparent;
            border-top-color: var(--accent-gold);
            animation: breathRotate 12s linear infinite;
        }

        @keyframes breathRotate {
            to {
                transform: rotate(360deg);
            }
        }

        .breath-inner {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(214, 158, 46, 0.3), transparent);
            animation: breathScale 12s ease-in-out infinite;
        }

        @keyframes breathScale {

            0%,
            100% {
                transform: scale(0.5);
                opacity: 0.3;
            }

            25% {
                transform: scale(1);
                opacity: 0.8;
            }

            50% {
                transform: scale(1);
                opacity: 0.8;
            }

            75% {
                transform: scale(0.5);
                opacity: 0.3;
            }
        }

        /* ===== ORACLE SPREAD ===== */
        .oracle-container {
            perspective: 1000px;
        }

        .oracle-card {
            width: 100%;
            max-width: 200px;
            height: 280px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .oracle-card.flipped {
            transform: rotateY(180deg);
        }

        .oracle-card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            border: 2px solid var(--border-primary);
        }

        .oracle-card-back {
            background: linear-gradient(135deg, #1c1917 0%, #292524 50%, #1c1917 100%);
            border-color: var(--accent-gold);
        }

        .oracle-card-back::before {
            content: '☿';
            font-size: 4rem;
            color: var(--accent-gold);
            opacity: 0.3;
            position: absolute;
        }

        .oracle-card-back::after {
            content: '';
            position: absolute;
            inset: 10px;
            border: 1px solid var(--accent-gold);
            border-radius: 8px;
            opacity: 0.3;
        }

        .oracle-card-front {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            transform: rotateY(180deg);
        }

        .oracle-position-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .oracle-principle-num {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--accent-gold);
            line-height: 1;
            margin-bottom: 0.5rem;
        }

        .oracle-principle-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            text-align: center;
        }

        /* Oracle synthesis animation */
        @keyframes oracleSynthesis {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .oracle-synthesis {
            animation: oracleSynthesis 0.6s ease-out forwards;
        }

        /* ===== EMERALD CONTEMPLATION MODE ===== */
        .contemplation-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        .contemplation-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .contemplation-content {
            max-width: 800px;
            padding: 2rem;
            text-align: center;
            position: relative;
        }

        /* Sacred geometry background */
        .sacred-geometry {
            position: absolute;
            inset: -100px;
            opacity: 0.05;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 400'%3E%3Ccircle cx='200' cy='200' r='150' fill='none' stroke='%23d69e2e' stroke-width='0.5'/%3E%3Ccircle cx='200' cy='200' r='100' fill='none' stroke='%23d69e2e' stroke-width='0.5'/%3E%3Ccircle cx='200' cy='200' r='50' fill='none' stroke='%23d69e2e' stroke-width='0.5'/%3E%3Cpolygon points='200,50 350,200 200,350 50,200' fill='none' stroke='%23d69e2e' stroke-width='0.5'/%3E%3Cpolygon points='200,100 300,200 200,300 100,200' fill='none' stroke='%23d69e2e' stroke-width='0.5'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            animation: slowRotate 120s linear infinite;
        }

        @keyframes slowRotate {
            to {
                transform: rotate(360deg);
            }
        }

        .contemplation-verse {
            font-size: 1.5rem;
            line-height: 1.8;
            color: var(--accent-gold);
            margin-bottom: 2rem;
            text-shadow: 0 0 30px rgba(214, 158, 46, 0.3);
        }

        .contemplation-timer {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 2px solid var(--accent-gold);
            margin: 2rem auto;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timer-progress {
            position: absolute;
            inset: -2px;
            border-radius: 50%;
            border: 2px solid transparent;
            border-top-color: var(--accent-gold);
            transition: transform 1s linear;
        }

        .timer-display {
            font-size: 2rem;
            color: var(--accent-gold);
            font-weight: 300;
        }

        .contemplation-journal {
            width: 100%;
            max-width: 600px;
            margin: 2rem auto 0;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(214, 158, 46, 0.2);
            border-radius: 12px;
            padding: 1rem;
            color: var(--text-primary);
            font-size: 1rem;
            resize: none;
            min-height: 120px;
            transition: opacity 0.5s ease;
        }

        .contemplation-journal::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .contemplation-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-muted);
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .contemplation-close:hover {
            background: rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
        }

        /* Breathing guide in contemplation */
        .breath-guide {
            color: var(--text-muted);
            font-size: 0.875rem;
            margin-top: 1rem;
            animation: breathText 12s ease-in-out infinite;
        }

        @keyframes breathText {

            0%,
            100% {
                opacity: 0.3;
            }

            12.5% {
                opacity: 1;
            }

            25% {
                opacity: 0.3;
            }

            37.5% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }

            62.5% {
                opacity: 1;
            }

            75% {
                opacity: 0.3;
            }

            87.5% {
                opacity: 1;
            }
        }

        /* Contemplation enter button */
        .enter-contemplation {
            position: relative;
            overflow: hidden;
            background: transparent;
            border: 1px solid var(--accent-gold);
            color: var(--accent-gold);
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .enter-contemplation:hover {
            background: var(--accent-gold);
            color: var(--bg-primary);
            box-shadow: 0 0 30px rgba(214, 158, 46, 0.3);
        }

        /* Duration buttons */
        .duration-btn {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            border: 1px solid rgba(214, 158, 46, 0.3);
            background: transparent;
            color: var(--text-muted);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .duration-btn:hover,
        .duration-btn.active {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        /* Custom Utility Classes for Library */
        .text-accent-gold {
            color: var(--accent-gold);
        }

        .text-themed {
            color: var(--text-primary);
        }

        .text-themed-secondary {
            color: var(--text-secondary);
        }

        .text-themed-muted {
            color: var(--text-muted);
        }

        .border-themed {
            border-color: var(--border-secondary);
        }

        .bg-bg-primary {
            background-color: var(--bg-primary);
        }

        .bg-bg-secondary {
            background-color: var(--bg-secondary);
        }

        .bg-bg-tertiary {
            background-color: var(--bg-tertiary);
        }

        /* Scrollbar for Reader */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: var(--border-primary);
            border-radius: 20px;
        }

        /* 3D Oracle Card Animation Utilities */
        .perspective-1000 {
            perspective: 1000px;
        }

        .transform-style-3d {
            transform-style: preserve-3d;
        }

        .backface-hidden {
            backface-visibility: hidden;
        }

        .rotate-y-180 {
            transform: rotateY(180deg);
        }

        .oracle-card.flipped .card-inner {
            transform: rotateY(180deg);
        }
    </style>
</head>

<body class="antialiased">

    <!-- Floating Particles Background -->
    <div class="particles-container" id="particles"></div>

    <!-- Navigation Bar -->
    <nav class="sticky top-0 z-50 backdrop-blur-sm border-b shadow-sm"
        style="background: var(--bg-nav); border-color: var(--border-primary);">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-3">
                    <div class="hermetic-logo" onclick="navTo('hero')" title="Return to top">H</div>
                    <span
                        class="serif-header text-xl sm:text-2xl font-bold tracking-tight text-themed hidden sm:inline">The
                        Hermetic
                        Codex</span>
                </div>
                <div class="hidden md:flex items-center space-x-6 lg:space-x-8">
                    <button onclick="navTo('principles')"
                        class="nav-link text-themed-secondary hover:text-themed px-3 py-2 rounded-md text-sm font-medium">The
                        7 Principles</button>
                    <button onclick="navTo('methodology')"
                        class="nav-link text-themed-secondary hover:text-themed px-3 py-2 rounded-md text-sm font-medium">Methodology</button>
                    <button onclick="navTo('source')"
                        class="nav-link text-themed-secondary hover:text-themed px-3 py-2 rounded-md text-sm font-medium">Emerald
                        Tablet</button>
                    <button onclick="navTo('reflection')"
                        class="nav-link text-themed-secondary hover:text-themed px-3 py-2 rounded-md text-sm font-medium">Self-Mastery</button>
                    <button onclick="navTo('oracle-section')"
                        class="nav-link text-themed-secondary hover:text-themed px-3 py-2 rounded-md text-sm font-medium">Oracle</button>
                    <button onclick="navTo('archives-section')"
                        class="nav-link text-themed-secondary hover:text-themed px-3 py-2 rounded-md text-sm font-medium">Archives</button>

                    <!-- Dark Mode Button -->
                    <button onclick="toggleDarkMode()" class="theme-toggle touch-target" aria-label="Toggle dark mode"
                        title="Toggle dark mode">
                        <svg class="sun-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            style="color: var(--accent-gold);" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                        <svg class="moon-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            style="color: var(--accent-gold);" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                        </svg>
                    </button>
                </div>
                <!-- Mobile menu button -->
                <div class="md:hidden flex items-center gap-3">
                    <!-- Mobile Dark Mode Button -->
                    <button onclick="toggleDarkMode()" class="theme-toggle touch-target" aria-label="Toggle dark mode"
                        title="Toggle dark mode">
                        <svg class="sun-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            style="color: var(--accent-gold);" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                        <svg class="moon-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            style="color: var(--accent-gold);" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                        </svg>
                    </button>
                    <button onclick="toggleMobileMenu()" class="hamburger touch-target" id="hamburger"
                        aria-label="Toggle menu">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                </div>
            </div>
        </div>
        <!-- Mobile Menu Panel -->
        <div id="mobile-menu" class="md:hidden border-t" style="border-color: var(--border-secondary);">
            <div class="px-4 py-3 space-y-1">
                <button onclick="navTo('principles')"
                    class="touch-target flex items-center w-full text-left px-4 py-3 rounded-lg text-base font-medium text-themed-secondary hover:bg-themed-tertiary ripple">The
                    7 Principles</button>
                <button onclick="navTo('methodology')"
                    class="touch-target flex items-center w-full text-left px-4 py-3 rounded-lg text-base font-medium text-themed-secondary hover:bg-themed-tertiary ripple">Methodology
                    & Practice</button>
                <button onclick="navTo('source')"
                    class="touch-target flex items-center w-full text-left px-4 py-3 rounded-lg text-base font-medium text-themed-secondary hover:bg-themed-tertiary ripple">The
                    Emerald Tablet</button>
                <button onclick="navTo('reflection')"
                    class="touch-target flex items-center w-full text-left px-4 py-3 rounded-lg text-base font-medium text-themed-secondary hover:bg-themed-tertiary ripple">Self-Mastery</button>
                <button onclick="navTo('oracle-section')"
                    class="touch-target flex items-center w-full text-left px-4 py-3 rounded-lg text-base font-medium text-themed-secondary hover:bg-themed-tertiary ripple">Oracle</button>
                <button onclick="navTo('archives-section')"
                    class="touch-target flex items-center w-full text-left px-4 py-3 rounded-lg text-base font-medium text-themed-secondary hover:bg-themed-tertiary ripple">Archives</button>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-10 space-y-12 sm:space-y-16">

        <!-- Intro Section -->
        <section id="intro" class="text-center max-w-3xl mx-auto hero-gradient pt-4 sm:pt-8 pb-8 reveal">
            <h1 class="serif-header text-3xl sm:text-4xl md:text-5xl font-bold text-themed mb-4 sm:mb-6 fade-in">As
                Above, So Below</h1>
            <p class="text-base sm:text-lg text-themed-secondary leading-relaxed mb-6 sm:mb-8 px-2 fade-in"
                style="animation-delay: 0.1s;">
                Welcome to the intersection of ancient wisdom and modern logic. You seek a methodology, not just
                history.
                Hermeticism, attributed to <strong class="text-themed">Hermes Trismegistus</strong> (the Greek parallel
                to the Egyptian <strong class="text-themed">Thoth</strong>),
                is not a religion of blind faith, but a philosophy of <strong class="gold-accent">Universal
                    Law</strong>.
            </p>
            <div
                class="h-1 w-24 bg-gradient-to-r from-transparent via-amber-500 to-transparent mx-auto rounded-full accent-line pulse-glow">
            </div>
        </section>

        <!-- SECTION 1: The 7 Principles -->
        <section id="principles" class="scroll-mt-20 reveal">
            <div class="mb-6 sm:mb-8">
                <h2 class="serif-header text-2xl sm:text-3xl font-bold text-themed mb-3 sm:mb-4">I. The 7 Hermetic
                    Principles</h2>
                <p class="text-themed-muted text-sm sm:text-base max-w-4xl">
                    The Kybalion outlines seven immutable laws. For a logical mind, treat these not as religious dogmas,
                    but as
                    <strong class="text-themed-secondary">axioms of the system</strong>. Tap any card to explore its
                    logical application.
                </p>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6" id="principles-grid">
                <!-- Cards injected via JS -->
            </div>

            <!-- Principle Detail View -->
            <div id="principle-detail"
                class="hidden mt-6 sm:mt-8 bg-themed border border-themed rounded-xl shadow-lg p-5 sm:p-6 md:p-8">
                <div class="flex flex-col gap-4 sm:gap-6">
                    <div class="flex-1">
                        <h3 id="detail-title" class="serif-header text-xl sm:text-2xl font-bold text-themed mb-2">
                        </h3>
                        <p id="detail-desc" class="text-themed-muted mb-4 italic text-sm sm:text-base"></p>
                        <div class="bg-themed-tertiary p-4 rounded-lg border-l-4"
                            style="border-left-color: var(--accent-gold);">
                            <h4 class="font-bold text-xs sm:text-sm text-themed uppercase tracking-wide mb-1">Logical
                                Application</h4>
                            <p id="detail-app" class="text-themed-secondary text-sm sm:text-base"></p>
                        </div>
                    </div>
                    <div class="w-full">
                        <div class="p-4 sm:p-5 rounded-lg shadow-lg"
                            style="background: var(--bg-card-dark); color: var(--text-primary);">
                            <h4 class="font-bold text-xs sm:text-sm uppercase tracking-wide mb-2 border-b pb-2"
                                style="border-color: var(--border-primary); color: var(--accent-gold);">The Practice
                            </h4>
                            <p id="detail-practice" class="text-sm leading-relaxed"
                                style="color: var(--text-secondary);"></p>
                        </div>
                    </div>
                </div>
                <button onclick="closePrincipleDetail()"
                    class="mt-4 w-full sm:w-auto px-4 py-2 text-sm font-medium text-themed-muted hover:text-themed ripple rounded-lg transition-all">
                    ← Back to Principles
                </button>
            </div>
        </section>

        <!-- SECTION 2: Methodology -->
        <section id="methodology" class="scroll-mt-20 border-t pt-12 sm:pt-16 reveal"
            style="border-color: var(--border-secondary);">
            <div class="mb-6 sm:mb-8">
                <h2 class="serif-header text-2xl sm:text-3xl font-bold text-themed mb-3 sm:mb-4">II. The Methodology
                    of Transmutation</h2>
                <p class="text-themed-muted text-sm sm:text-base max-w-3xl">
                    Based on the <em>Principle of Polarity</em>, emotions are not fixed entities but degrees on a
                    sliding scale.
                    Fear and Courage are the same thing, just at different frequencies. We do not destroy emotions; we
                    <strong class="gold-accent">transmute</strong> them.
                </p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
                <!-- Interactive Transmutation Tool -->
                <div class="bg-themed p-5 sm:p-6 rounded-xl border border-themed shadow-sm order-2 lg:order-1">
                    <h3 class="serif-header text-lg sm:text-xl font-bold text-themed mb-3 sm:mb-4">The Alchemist's Dial
                    </h3>
                    <p class="text-xs sm:text-sm text-themed-muted mb-4 sm:mb-6">
                        Rotate the dial to transmute your emotional state. As above, so below — as within, so you
                        become.
                    </p>

                    <div class="polarity-buttons mb-6">
                        <button onclick="setDialPolarity('fear')" id="btn-fear" class="polarity-btn active ripple">Fear
                            ↔
                            Courage</button>
                        <button onclick="setDialPolarity('grief')" id="btn-grief" class="polarity-btn ripple">Grief ↔
                            Peace</button>
                        <button onclick="setDialPolarity('lethargy')" id="btn-lethargy"
                            class="polarity-btn ripple">Lethargy
                            ↔ Passion</button>
                    </div>

                    <div class="alchemy-dial-container">
                        <div class="alchemy-dial" id="alchemyDial">
                            <!-- Dial markers -->
                            <div class="dial-markers" id="dialMarkers"></div>
                            <!-- Pointer -->
                            <div class="dial-pointer" id="dialPointer"></div>
                            <!-- Center knob -->
                            <div class="dial-knob"></div>
                            <!-- Labels -->
                            <div class="dial-labels">
                                <span class="dial-label positive" id="dialLabelPos">Courage</span>
                                <span class="dial-label negative" id="dialLabelNeg">Fear</span>
                            </div>
                        </div>

                        <div class="dial-value-display">
                            <span class="dial-value" id="dialValue">20%</span>
                            <span class="dial-state-label" id="dialStateLabel">Lead State</span>
                        </div>

                        <p class="transmutation-hint">Drag the dial clockwise to raise your vibration</p>
                    </div>
                </div>

                <!-- The Practical List -->
                <div class="space-y-4 sm:space-y-6 order-1 lg:order-2">
                    <div class="bg-themed-tertiary p-4 sm:p-6 rounded-xl border border-themed reveal reveal-delay-1">
                        <h4 class="font-bold text-themed mb-2 text-sm sm:text-base">Meditation & Mindfulness</h4>
                        <p class="text-xs sm:text-sm text-themed-secondary mb-2">
                            <strong>Principle:</strong> Mentalism ("The All is Mind").
                        </p>
                        <p class="text-xs sm:text-sm text-themed-muted">
                            <em>Practice:</em> 10 minutes daily observing thoughts as external objects. Do not judge;
                            just observe.
                        </p>
                    </div>

                    <div class="bg-themed-tertiary p-4 sm:p-6 rounded-xl border border-themed reveal reveal-delay-2">
                        <h4 class="font-bold text-themed mb-2 text-sm sm:text-base">Passion & Restraint</h4>
                        <p class="text-xs sm:text-sm text-themed-secondary mb-2">
                            <strong>Principle:</strong> Rhythm (The Pendulum Swing).
                        </p>
                        <p class="text-xs sm:text-sm text-themed-muted">
                            <em>Practice:</em> "Neutralization". When you feel extreme joy, stay grounded. Maintain the
                            "Upper Path" of stability.
                        </p>
                    </div>

                    <div class="bg-themed-tertiary p-4 sm:p-6 rounded-xl border border-themed reveal reveal-delay-3">
                        <h4 class="font-bold text-themed mb-2 text-sm sm:text-base">Prayer & Hope</h4>
                        <p class="text-xs sm:text-sm text-themed-secondary mb-2">
                            <strong>Principle:</strong> Cause and Effect.
                        </p>
                        <p class="text-xs sm:text-sm text-themed-muted">
                            <em>Practice:</em> Replace "Hope" with "Alignment". Speak intent as if it has occurred. "I
                            am peaceful" sets a vibration.
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION 3: The Emerald Tablet -->
        <section id="source" class="scroll-mt-20 border-t pt-12 sm:pt-16 reveal"
            style="border-color: var(--border-secondary);">
            <h2 class="serif-header text-2xl sm:text-3xl font-bold text-themed mb-4 sm:mb-6">III. The Emerald Tablet
            </h2>
            <p class="text-themed-muted text-sm sm:text-base mb-6 sm:mb-8 max-w-3xl">
                Attributed to Hermes Trismegistus — the cryptic source of alchemical wisdom.
                Tap on the cryptic text to reveal the <strong class="gold-accent">Logical Interpretation</strong>.
            </p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4" id="tablet-grid">
                <!-- Tablet content injected via JS -->
            </div>
        </section>

        <!-- SECTION 4: Self-Reflection -->
        <section id="reflection" class="scroll-mt-20 border-t pt-12 sm:pt-16 pb-12 sm:pb-20 reveal"
            style="border-color: var(--border-secondary);">
            <h2 class="serif-header text-2xl sm:text-3xl font-bold text-themed mb-4 sm:mb-6">IV. The Alchemist's Balance
            </h2>
            <div class="flex flex-col lg:flex-row gap-8 lg:gap-12">
                <div class="w-full lg:w-1/2">
                    <p class="text-themed-muted text-sm sm:text-base mb-6">
                        Progress in Hermeticism requires balance. A purely logical mind without action is stagnant.
                        Use this chart to visualize your current <strong class="gold-accent">"Alchemical
                            Configuration"</strong>.
                    </p>

                    <div class="bg-themed p-4 sm:p-6 rounded-xl shadow-sm border border-themed">
                        <h4 class="font-bold text-themed mb-4 text-sm sm:text-base">Self-Assessment Quick-Check:</h4>
                        <div class="space-y-1">
                            <div class="assessment-item">
                                <span class="text-sm text-themed-secondary">Logic / Study (Mentalism)</span>
                                <input type="range" class="w-full sm:w-40" onchange="updateRadar(0, this.value)" min="1"
                                    max="10" value="8">
                            </div>
                            <div class="assessment-item">
                                <span class="text-sm text-themed-secondary">Adaptability (Correspondence)</span>
                                <input type="range" class="w-full sm:w-40" onchange="updateRadar(1, this.value)" min="1"
                                    max="10" value="6">
                            </div>
                            <div class="assessment-item">
                                <span class="text-sm text-themed-secondary">Energy / Health (Vibration)</span>
                                <input type="range" class="w-full sm:w-40" onchange="updateRadar(2, this.value)" min="1"
                                    max="10" value="5">
                            </div>
                            <div class="assessment-item">
                                <span class="text-sm text-themed-secondary">Emotional Control (Polarity)</span>
                                <input type="range" class="w-full sm:w-40" onchange="updateRadar(3, this.value)" min="1"
                                    max="10" value="4">
                            </div>
                            <div class="assessment-item">
                                <span class="text-sm text-themed-secondary">Consistency (Rhythm)</span>
                                <input type="range" class="w-full sm:w-40" onchange="updateRadar(4, this.value)" min="1"
                                    max="10" value="5">
                            </div>
                            <div class="assessment-item">
                                <span class="text-sm text-themed-secondary">Action / Discipline (Cause & Effect)</span>
                                <input type="range" class="w-full sm:w-40" onchange="updateRadar(5, this.value)" min="1"
                                    max="10" value="7">
                            </div>
                            <div class="assessment-item">
                                <span class="text-sm text-themed-secondary">Creativity / Balance (Gender)</span>
                                <input type="range" class="w-full sm:w-40" onchange="updateRadar(6, this.value)" min="1"
                                    max="10" value="6">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="w-full lg:w-1/2 flex justify-center items-center">
                    <div class="chart-container w-full max-w-md">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION 5: Daily Alignment Ritual -->
        <section id="ritual" class="scroll-mt-20 border-t pt-12 sm:pt-16 reveal"
            style="border-color: var(--border-secondary);">
            <h2 class="serif-header text-2xl sm:text-3xl font-bold text-themed mb-4 sm:mb-6">V. Daily Alignment Ritual
            </h2>
            <p class="text-themed-muted text-sm sm:text-base mb-6 sm:mb-8 max-w-3xl">
                Each day carries unique energy from its <strong class="gold-accent">planetary ruler</strong>.
                The Gnostics taught that we ascend through the seven spheres; each day offers a gate.
                Align your morning practice with the celestial current.
            </p>

            <div class="ritual-card rounded-xl p-6 sm:p-8 relative z-10" id="ritual-container">
                <!-- Content injected by JS based on current day -->
                <div class="flex flex-col lg:flex-row gap-8 items-center">
                    <!-- Left: Day & Planet Info -->
                    <div class="flex-1 text-center lg:text-left">
                        <div class="flex items-center justify-center lg:justify-start gap-4 mb-4">
                            <span class="planetary-symbol" id="ritual-planet-symbol">☉</span>
                            <div>
                                <p class="text-themed-muted text-xs uppercase tracking-widest">Today's Ruler</p>
                                <h3 class="serif-header text-2xl font-bold text-themed" id="ritual-day-title">Sunday —
                                    Sol</h3>
                            </div>
                        </div>
                        <p class="text-themed-secondary text-sm mb-4" id="ritual-day-description">
                            The Sun governs identity, will, and self-expression. A day for centering the Self.
                        </p>
                        <div class="flex items-center justify-center lg:justify-start gap-3 mb-4">
                            <span class="moon-phase-icon" id="ritual-moon-icon">🌓</span>
                            <div>
                                <p class="text-xs text-themed-muted uppercase tracking-wide">Moon Phase</p>
                                <p class="text-sm text-themed-secondary" id="ritual-moon-phase">First Quarter — Building
                                    Energy</p>
                            </div>
                        </div>
                        <div class="p-4 rounded-lg bg-themed-tertiary border border-themed">
                            <p class="text-xs text-themed-muted uppercase tracking-wide mb-2">Principle of Focus</p>
                            <p class="serif-header text-lg font-bold gold-accent" id="ritual-principle">Mentalism</p>
                            <p class="text-sm text-themed-muted mt-1" id="ritual-principle-hint">
                                The All is Mind. Today, observe your thoughts as the source of your reality.
                            </p>
                        </div>
                    </div>

                    <!-- Right: Breathwork & Affirmation -->
                    <div class="flex-1 text-center">
                        <p class="text-xs text-themed-muted uppercase tracking-widest mb-4">Morning Breathwork</p>
                        <div class="breath-circle mb-4">
                            <div class="breath-inner"></div>
                        </div>
                        <p class="text-xs text-themed-muted mb-6">
                            Inhale 4s • Hold 4s • Exhale 4s • Hold 4s<br>
                            <span class="text-themed-secondary">Repeat 7 times (one for each sphere)</span>
                        </p>

                        <div class="p-4 rounded-lg" style="background: var(--bg-card-dark);">
                            <p class="text-xs uppercase tracking-widest mb-2" style="color: var(--accent-gold);">Morning
                                Invocation</p>
                            <p class="serif-header text-base sm:text-lg italic" style="color: var(--text-secondary);"
                                id="ritual-affirmation">
                                "I am the observer of my mind. My thoughts shape reality. I choose alignment."
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION 6: The Oracle Spread -->
        <section id="oracle" class="scroll-mt-20 border-t pt-12 sm:pt-16 reveal"
            style="border-color: var(--border-secondary);">
            <h2 class="serif-header text-2xl sm:text-3xl font-bold text-themed mb-4 sm:mb-6">VI. The Oracle Spread</h2>
            <p class="text-themed-muted text-sm sm:text-base mb-6 sm:mb-8 max-w-3xl">
                Draw three principles that <strong class="gold-accent">correspond</strong> to your current moment.
                The Hermetic triad: <em>Thesis</em> (what was), <em>Antithesis</em> (what is), <em>Synthesis</em> (what
                can be).
                Nothing is random — what appears speaks to your current vibration.
            </p>

            <div class="text-center mb-8">
                <button onclick="drawOracleSpread()" class="polarity-btn active ripple" id="oracle-draw-btn">
                    ✦ Draw Your Spread ✦
                </button>
            </div>

            <div class="flex flex-col sm:flex-row justify-center items-center gap-6 sm:gap-8 oracle-container"
                id="oracle-cards">
                <!-- Card 1: Past/Thesis -->
                <div class="oracle-card" id="oracle-card-0" onclick="flipOracleCard(0)">
                    <div class="oracle-card-face oracle-card-back"></div>
                    <div class="oracle-card-face oracle-card-front">
                        <span class="oracle-position-label">What Was</span>
                        <span class="oracle-principle-num" id="oracle-num-0">I</span>
                        <span class="oracle-principle-title" id="oracle-title-0">Mentalism</span>
                    </div>
                </div>

                <!-- Card 2: Present/Antithesis -->
                <div class="oracle-card" id="oracle-card-1" onclick="flipOracleCard(1)">
                    <div class="oracle-card-face oracle-card-back"></div>
                    <div class="oracle-card-face oracle-card-front">
                        <span class="oracle-position-label">What Is</span>
                        <span class="oracle-principle-num" id="oracle-num-1">IV</span>
                        <span class="oracle-principle-title" id="oracle-title-1">Polarity</span>
                    </div>
                </div>

                <!-- Card 3: Future/Synthesis -->
                <div class="oracle-card" id="oracle-card-2" onclick="flipOracleCard(2)">
                    <div class="oracle-card-face oracle-card-back"></div>
                    <div class="oracle-card-face oracle-card-front">
                        <span class="oracle-position-label">What Can Be</span>
                        <span class="oracle-principle-num" id="oracle-num-2">VII</span>
                        <span class="oracle-principle-title" id="oracle-title-2">Gender</span>
                    </div>
                </div>
            </div>

            <!-- Oracle Synthesis Message -->
            <div id="oracle-synthesis" class="hidden mt-8 max-w-2xl mx-auto text-center p-6 rounded-xl"
                style="background: var(--bg-card-dark);">
                <p class="text-xs uppercase tracking-widest mb-3" style="color: var(--accent-gold);">The Synthesis</p>
                <p class="serif-header text-lg sm:text-xl italic" style="color: var(--text-secondary);"
                    id="oracle-synthesis-text">
                    <!-- Synthesis message injected by JS -->
                </p>
            </div>
        </section>

        <!-- SECTION 7: Emerald Contemplation -->
        <section id="contemplate" class="scroll-mt-20 border-t pt-12 sm:pt-16 pb-12 sm:pb-20 reveal"
            style="border-color: var(--border-secondary);">
            <h2 class="serif-header text-2xl sm:text-3xl font-bold text-themed mb-4 sm:mb-6">VII. Emerald Contemplation
            </h2>
            <p class="text-themed-muted text-sm sm:text-base mb-6 sm:mb-8 max-w-3xl">
                Enter a state of <strong class="gold-accent">henosis</strong> — union with the Higher Mind.
                The Gnostics called this <em>gnosis</em>: direct knowing beyond words.
                Select a verse from the Emerald Tablet. Breathe. Contemplate. Let understanding arise.
            </p>

            <div class="flex flex-col sm:flex-row items-center justify-center gap-4 sm:gap-6">
                <select id="contemplation-verse-select"
                    class="bg-themed border border-themed rounded-lg px-4 py-3 text-themed text-sm w-full sm:w-auto max-w-md">
                    <option value="0">"Tis true without lying, certain & most true."</option>
                    <option value="1">"That which is below is like that which is above..."</option>
                    <option value="2">"And as all things have been & arose from one..."</option>
                    <option value="3">"The Sun is its father, the moon its mother..."</option>
                    <option value="4">"Separate thou the earth from the fire..."</option>
                    <option value="5">"Its force is entire if converted into earth."</option>
                </select>

                <div class="flex gap-2">
                    <button class="duration-btn" data-duration="180" onclick="setContemplationDuration(180, this)">3
                        min</button>
                    <button class="duration-btn active" data-duration="420"
                        onclick="setContemplationDuration(420, this)">7 min</button>
                    <button class="duration-btn" data-duration="720" onclick="setContemplationDuration(720, this)">12
                        min</button>
                </div>

                <button onclick="enterContemplation()" class="enter-contemplation">
                    ◎ Enter Contemplation
                </button>
                <button onclick="navTo('oracle-section')"
                    class="nav-link text-sm font-medium hover:text-accent-gold transition-colors">Oracle</button>
                <button onclick="navTo('archives-section')"
                    class="nav-link text-sm font-medium hover:text-accent-gold transition-colors">Archives</button>
            </div>
        </section>

    </main>

    <!-- Contemplation Overlay (Full Screen) -->
    <div class="contemplation-overlay" id="contemplation-overlay">
        <div class="sacred-geometry"></div>
        <button class="contemplation-close" onclick="exitContemplation()">✕</button>

        <div class="contemplation-content">
            <p class="text-xs uppercase tracking-widest mb-6" style="color: var(--text-muted);">Emerald Contemplation
            </p>

            <p class="contemplation-verse serif-header" id="contemplation-verse-display">
                "Tis true without lying, certain & most true."
            </p>

            <div class="contemplation-timer" id="contemplation-timer">
                <div class="timer-progress" id="timer-progress"></div>
                <span class="timer-display" id="timer-display">7:00</span>
            </div>

            <p class="breath-guide" id="breath-guide">Breathe... Inhale... Hold... Exhale... Hold...</p>

            <textarea class="contemplation-journal" id="contemplation-journal"
                placeholder="After contemplation, record your insights here... What arose from silence? What did you remember?"></textarea>

            <div class="mt-4">
                <button onclick="exitContemplation()" class="enter-contemplation">
                    Complete Session
                </button>
            </div>
        </div>
    </div>



    <footer class="relative z-10 py-8 sm:py-10 border-t"
        style="background: var(--bg-card-dark); border-color: var(--border-primary);">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="serif-header text-base sm:text-lg mb-2" style="color: var(--accent-gold);">"The lips of wisdom are
                closed, except to the ears of Understanding."</p>
            <p class="text-xs sm:text-sm text-themed-muted opacity-60">- The Kybalion</p>
            <div class="mt-6 sm:mt-8 text-xs text-themed-muted opacity-50">
                A tool for the Rational Mystic. Generated for research and practice.
            </div>
        </div>
    </footer>

    <script>
        // --- DATA & STATE ---

        const principlesData = [
            {
                id: 1,
                title: "I. Mentalism",
                desc: "The All is Mind; The Universe is Mental.",
                app: "Reality is a projection of consciousness. To change your external world, you must first change your internal thoughts/beliefs.",
                practice: "Mindfulness. Monitor your internal monologue. If the Universe is mental, your thoughts are the code running the simulation. Debug them."
            },
            {
                id: 2,
                title: "II. Correspondence",
                desc: "As above, so below; as below, so above.",
                app: "Patterns repeat on all scales (fractals). Understanding the atom helps understand the solar system. Understanding your emotions helps understand human nature.",
                practice: "Study patterns. If you feel chaos inside, look for chaos in your environment (messy room, unfinished tasks). Fix the 'Below' to fix the 'Above'."
            },
            {
                id: 3,
                title: "III. Vibration",
                desc: "Nothing rests; everything moves; everything vibrates.",
                app: "Science confirms matter is just energy vibrating at slow speeds. Moods and thoughts are also vibrations. High vibes (Love) dissolve low vibes (Fear).",
                practice: "State Management. You can change your mental state by forcing a physical change (breathing, movement, music). You are tuning an instrument."
            },
            {
                id: 4,
                title: "IV. Polarity",
                desc: "Everything is dual; everything has poles; opposites are identical in nature, but different in degree.",
                app: "Hot and Cold are the same thing (Temperature). Hate and Love are the same thing (Emotional Attachment). You can slide from one to the other.",
                practice: "Transmutation. When you feel Fear, do not fight it. Recognize it as the same energy as Courage, just low frequency. Dial it up."
            },
            {
                id: 5,
                title: "V. Rhythm",
                desc: "Everything flows, out and in; everything has its tides.",
                app: "Life acts like a pendulum. Highs follow lows. Motivation follows burnout. This is natural law, not personal failure.",
                practice: "Neutralization. When you hit a 'low' period, don't panic. Know it is the backswing. Rest, wait, and prepare for the inevitable forward swing."
            },
            {
                id: 6,
                title: "VI. Cause & Effect",
                desc: "Every Cause has its Effect; every Effect has its Cause.",
                app: "There is no 'Chance'. Luck is just a name for law not recognized. You are either a Master (Causing things) or a Pawn (Effect of others).",
                practice: "Proactivity. Stop reacting to life. Initiate action. Plant seeds (Causes) deliberately to harvest specific crops (Effects)."
            },
            {
                id: 7,
                title: "VII. Gender",
                desc: "Gender is in everything; everything has its Masculine and Feminine principles.",
                app: "Not biological sex. Masculine is Will/Projective. Feminine is Creative/Receptive. Balance is needed for creation.",
                practice: "Balance. Are you all 'Will' (Burnout)? Or all 'Dreaming' (Stagnation)? Combine the Will to Act with the Patience to Nurture."
            }
        ];

        const tabletData = [
            {
                verse: "Tis true without lying, certain & most true.",
                logic: "This is an affirmation of objective reality. The Alchemist seeks Truth, not illusion."
            },
            {
                verse: "That which is below is like that which is above...",
                logic: "The Holographic Universe theory. The macrocosm reflects the microcosm. By changing yourself (micro), you influence your reality (macro)."
            },
            {
                verse: "And as all things have been & arose from one...",
                logic: "The Singularity. All matter and energy come from a single source (The All). We are all connected by origin."
            },
            {
                verse: "The Sun is its father, the moon its mother...",
                logic: "Symbolism for elements: Sun (Active/Fire), Moon (Passive/Water), Wind (Air/Mind), Earth (Matter/Body). Harmony of elements is key."
            },
            {
                verse: "Separate thou the earth from the fire, the subtle from the gross...",
                logic: "CRITICAL PRACTICE: Separate facts (earth) from emotions (fire). Distinguish subtle truth from gross noise. Do this calmly and with effort."
            },
            {
                verse: "Its force or power is entire if it be converted into earth.",
                logic: "Wisdom is useless unless grounded. Theory must become Action. Logic must become Practice."
            }
        ];

        // --- CHART INSTANCES ---
        let polarityChartInstance = null;
        let radarChartInstance = null;

        // --- DOM ELEMENTS ---
        const principlesGrid = document.getElementById('principles-grid');
        const detailSection = document.getElementById('principle-detail');
        const tabletGrid = document.getElementById('tablet-grid');
        const slider = document.getElementById('vibrationSlider');

        // --- DARK MODE ---

        function initDarkMode() {
            const savedTheme = localStorage.getItem('hermetic-theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.documentElement.classList.add('dark');
            }
        }

        function toggleDarkMode() {
            const html = document.documentElement;
            const isDark = html.classList.toggle('dark');
            localStorage.setItem('hermetic-theme', isDark ? 'dark' : 'light');

            // Update charts for new theme
            updateChartTheme();
        }

        function updateChartTheme() {
            const isDark = document.documentElement.classList.contains('dark');
            const gridColor = isDark ? '#44403c' : '#e7e5e4';
            const textColor = isDark ? '#a8a29e' : '#44403c';

            if (radarChartInstance) {
                radarChartInstance.options.scales.r.angleLines.color = gridColor;
                radarChartInstance.options.scales.r.grid.color = gridColor;
                radarChartInstance.options.scales.r.pointLabels.color = textColor;
                radarChartInstance.update();
            }

            if (polarityChartInstance) {
                polarityChartInstance.options.plugins.legend.labels.color = textColor;
                polarityChartInstance.update();
            }
        }

        // --- FLOATING PARTICLES ---

        function createParticles() {
            const container = document.getElementById('particles');
            const particleCount = 15;

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.animationDelay = `${Math.random() * 20}s`;
                particle.style.animationDuration = `${15 + Math.random() * 10}s`;
                particle.style.width = `${2 + Math.random() * 4}px`;
                particle.style.height = particle.style.width;
                container.appendChild(particle);
            }
        }

        // --- SCROLL REVEAL ---

        function initScrollReveal() {
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('revealed');
                        observer.unobserve(entry.target);
                    }
                });
            }, observerOptions);

            document.querySelectorAll('.reveal').forEach(el => {
                observer.observe(el);
            });
        }

        // --- INITIALIZATION ---

        function init() {
            initDarkMode();
            createParticles();
            renderPrinciples();
            renderTablet();
            initPolarityChart();
            initRadarChart();
            initAlchemyDial();

            // Initialize scroll reveal after a brief delay
            setTimeout(initScrollReveal, 100);

            slider.addEventListener('input', (e) => {
                updatePolarityChart(e.target.value);
            });
        }

        // --- RENDER FUNCTIONS ---

        function renderPrinciples() {
            principlesGrid.innerHTML = principlesData.map((p, index) => `
                <div onclick="showPrincipleDetail(${p.id})" class="principle-card p-5 sm:p-6 rounded-xl border cursor-pointer group reveal reveal-delay-${index + 1}">
                    <h3 class="serif-header text-lg sm:text-xl font-bold text-themed-secondary group-hover:text-themed mb-2">${p.title}</h3>
                    <p class="text-xs sm:text-sm text-themed-muted line-clamp-2">${p.desc}</p>
                    <div class="mt-4 flex items-center text-xs font-bold text-themed-muted uppercase tracking-widest group-hover:text-amber-500 transition-colors">
                        Explore <span class="ml-1 transition-transform group-hover:translate-x-1">→</span>
                    </div>
                </div>
            `).join('');

            // Re-observe the new elements
            setTimeout(initScrollReveal, 50);
        }

        function showPrincipleDetail(id) {
            const p = principlesData.find(item => item.id === id);

            document.getElementById('detail-title').innerText = p.title;
            document.getElementById('detail-desc').innerText = `"${p.desc}"`;
            document.getElementById('detail-app').innerText = p.app;
            document.getElementById('detail-practice').innerText = p.practice;

            detailSection.classList.remove('hidden');

            setTimeout(() => {
                detailSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }

        function closePrincipleDetail() {
            detailSection.classList.add('hidden');
        }

        function renderTablet() {
            tabletGrid.innerHTML = tabletData.map((t, index) => `
                <div onclick="toggleTabletLogic(${index})" class="tablet-card p-4 sm:p-5 rounded-xl border cursor-pointer transition-all reveal reveal-delay-${index + 1}" style="background: var(--bg-card-dark); border-color: var(--border-primary);">
                    <p class="serif-header text-base sm:text-lg italic mb-2" style="color: var(--text-secondary);">"${t.verse}"</p>
                    <div id="tablet-logic-${index}" class="hidden mt-3 pt-3 border-t" style="border-color: var(--border-primary);">
                        <p class="text-xs sm:text-sm" style="color: var(--text-muted);"><span class="font-bold" style="color: var(--accent-gold);">Logic:</span> ${t.logic}</p>
                    </div>
                    <div class="text-center mt-2">
                        <span id="tablet-hint-${index}" class="text-xs uppercase tracking-widest transition-opacity" style="color: var(--text-light);">Tap to Decode</span>
                    </div>
                </div>
            `).join('');

            // Re-observe the new elements
            setTimeout(initScrollReveal, 50);
        }

        function toggleTabletLogic(index) {
            const el = document.getElementById(`tablet-logic-${index}`);
            const hint = document.getElementById(`tablet-hint-${index}`);
            const isHidden = el.classList.contains('hidden');

            el.classList.toggle('hidden');
            hint.innerText = isHidden ? 'Tap to Hide' : 'Tap to Decode';
        }

        // --- CHARTS ---

        function initPolarityChart() {
            const ctx = document.getElementById('polarityChart').getContext('2d');
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#a8a29e' : '#44403c';

            polarityChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Current State'],
                    datasets: [
                        {
                            label: 'Fear (Lead)',
                            data: [80],
                            backgroundColor: '#a8a29e',
                            barThickness: 50
                        },
                        {
                            label: 'Courage (Gold)',
                            data: [20],
                            backgroundColor: '#d69e2e',
                            barThickness: 50
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    animation: {
                        duration: 600,
                        easing: 'easeOutQuart'
                    },
                    scales: {
                        x: {
                            stacked: true,
                            max: 100,
                            display: false
                        },
                        y: {
                            stacked: true,
                            display: false
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 16,
                                font: { size: 11 },
                                color: textColor
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return context.dataset.label + ': ' + context.raw + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        let currentAxis = { neg: 'Fear', pos: 'Courage' };

        function setPolarity(type) {
            const sliderVal = document.getElementById('vibrationSlider');
            sliderVal.value = 20;

            // Update button states with animation
            document.querySelectorAll('.polarity-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${type}`).classList.add('active');

            if (type === 'fear') currentAxis = { neg: 'Fear', pos: 'Courage' };
            if (type === 'grief') currentAxis = { neg: 'Grief', pos: 'Peace' };
            if (type === 'lethargy') currentAxis = { neg: 'Lethargy', pos: 'Passion' };

            polarityChartInstance.data.datasets[0].label = `${currentAxis.neg} (Lead)`;
            polarityChartInstance.data.datasets[1].label = `${currentAxis.pos} (Gold)`;

            updatePolarityChart(20);
        }

        function updatePolarityChart(val) {
            const positiveVal = parseInt(val);
            const negativeVal = 100 - positiveVal;

            polarityChartInstance.data.datasets[0].data = [negativeVal];
            polarityChartInstance.data.datasets[1].data = [positiveVal];

            if (positiveVal > 60) {
                polarityChartInstance.data.datasets[1].backgroundColor = '#b45309';
            } else {
                polarityChartInstance.data.datasets[1].backgroundColor = '#d69e2e';
            }

            polarityChartInstance.update();
        }

        // ===== ALCHEMY DIAL =====
        let dialValue = 20;
        let dialCurrentAxis = { neg: 'Fear', pos: 'Courage' };
        let isDragging = false;

        function initAlchemyDial() {
            const dial = document.getElementById('alchemyDial');
            const markersContainer = document.getElementById('dialMarkers');

            if (!dial || !markersContainer) return;

            // Create dial markers
            for (let i = 0; i < 24; i++) {
                const marker = document.createElement('div');
                marker.className = 'dial-marker' + (i % 6 === 0 ? ' major' : '');
                marker.style.transform = `rotate(${i * 15}deg)`;
                markersContainer.appendChild(marker);
            }

            // Set initial pointer position
            updateDialPointer(dialValue);

            // Mouse events
            dial.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);

            // Touch events
            dial.addEventListener('touchstart', startDrag, { passive: false });
            document.addEventListener('touchmove', drag, { passive: false });
            document.addEventListener('touchend', stopDrag);
        }

        function startDrag(e) {
            e.preventDefault();
            isDragging = true;
            document.getElementById('alchemyDial').style.cursor = 'grabbing';
        }

        function stopDrag() {
            isDragging = false;
            const dial = document.getElementById('alchemyDial');
            if (dial) dial.style.cursor = 'grab';
        }

        function drag(e) {
            if (!isDragging) return;
            e.preventDefault();

            const dial = document.getElementById('alchemyDial');
            const rect = dial.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            // Calculate angle from center
            let angle = Math.atan2(clientY - centerY, clientX - centerX);
            angle = angle * (180 / Math.PI);

            // Convert to dial value (0-100)
            // Dial goes from bottom (0%) to top (100%)
            // Bottom = 90deg, Top = -90deg
            let value = ((90 - angle) / 180) * 100;
            value = Math.max(0, Math.min(100, value));

            dialValue = Math.round(value);
            updateDialPointer(dialValue);
            updateDialDisplay(dialValue);
        }

        function updateDialPointer(value) {
            const pointer = document.getElementById('dialPointer');
            if (!pointer) return;

            // Convert value (0-100) to angle
            // 0% = 180deg (bottom), 100% = 0deg (top)
            const angle = 180 - (value * 1.8);
            pointer.style.transform = `rotate(${angle}deg)`;
        }

        function updateDialDisplay(value) {
            const valueEl = document.getElementById('dialValue');
            const stateLabel = document.getElementById('dialStateLabel');

            if (!valueEl || !stateLabel) return;

            valueEl.textContent = value + '%';

            // Update state label and styling based on value
            if (value >= 70) {
                stateLabel.textContent = `${dialCurrentAxis.pos} (Transmuted!)`;
                stateLabel.classList.add('transmuted');
                valueEl.classList.add('transmuted');
            } else if (value >= 50) {
                stateLabel.textContent = 'Transmuting...';
                stateLabel.classList.remove('transmuted');
                valueEl.classList.remove('transmuted');
            } else {
                stateLabel.textContent = `${dialCurrentAxis.neg} State`;
                stateLabel.classList.remove('transmuted');
                valueEl.classList.remove('transmuted');
            }
        }

        function setDialPolarity(type) {
            // Update button states
            document.querySelectorAll('.polarity-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${type}`).classList.add('active');

            // Update axis
            if (type === 'fear') dialCurrentAxis = { neg: 'Fear', pos: 'Courage' };
            if (type === 'grief') dialCurrentAxis = { neg: 'Grief', pos: 'Peace' };
            if (type === 'lethargy') dialCurrentAxis = { neg: 'Lethargy', pos: 'Passion' };

            // Update dial labels
            document.getElementById('dialLabelPos').textContent = dialCurrentAxis.pos;
            document.getElementById('dialLabelNeg').textContent = dialCurrentAxis.neg;

            // Reset dial
            dialValue = 20;
            updateDialPointer(dialValue);
            updateDialDisplay(dialValue);
        }


        function initRadarChart() {
            const ctx = document.getElementById('radarChart').getContext('2d');
            const isDark = document.documentElement.classList.contains('dark');
            const gridColor = isDark ? '#44403c' : '#e7e5e4';
            const textColor = isDark ? '#a8a29e' : '#44403c';

            radarChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Mentalism', 'Correspondence', 'Vibration', 'Polarity', 'Rhythm', 'Cause & Effect', 'Gender'],
                    datasets: [{
                        label: 'Your Alchemical Balance',
                        data: [8, 6, 5, 4, 5, 7, 6],
                        fill: true,
                        backgroundColor: 'rgba(214, 158, 46, 0.2)',
                        borderColor: '#b45309',
                        pointBackgroundColor: '#78350f',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#78350f'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 600,
                        easing: 'easeOutQuart'
                    },
                    elements: {
                        line: { borderWidth: 2 }
                    },
                    scales: {
                        r: {
                            angleLines: { color: gridColor },
                            grid: { color: gridColor },
                            pointLabels: {
                                font: { size: 10, family: 'Inter' },
                                color: textColor
                            },
                            suggestedMin: 0,
                            suggestedMax: 10,
                            ticks: { display: false }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function updateRadar(index, value) {
            radarChartInstance.data.datasets[0].data[index] = parseInt(value);
            radarChartInstance.update();
        }

        // --- NAVIGATION ---

        function navTo(sectionId) {
            const el = document.getElementById(sectionId);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth' });
                closeMobileMenu();
            }
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const hamburger = document.getElementById('hamburger');

            menu.classList.toggle('open');
            hamburger.classList.toggle('open');
        }

        function closeMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const hamburger = document.getElementById('hamburger');

            menu.classList.remove('open');
            hamburger.classList.remove('open');
        }

        // Start App
        window.addEventListener('DOMContentLoaded', init);

        // ===== DAILY ALIGNMENT RITUAL =====

        const planetaryData = {
            0: { // Sunday
                planet: 'Sol',
                symbol: '☉',
                title: 'Sunday — Sol (The Sun)',
                description: 'The Sun governs identity, will, and self-expression. A day for centering the Self — the divine spark within. In Gnostic terms, this is your connection to the Monad.',
                principle: 'Mentalism',
                principleHint: 'The All is Mind. Today, observe your thoughts as the source of reality. You are the thinker behind the thought.',
                affirmation: '"I AM the observer of my mind. My thoughts shape reality. I align with the Source."',
                element: 'Fire'
            },
            1: { // Monday
                planet: 'Luna',
                symbol: '☽',
                title: 'Monday — Luna (The Moon)',
                description: 'The Moon governs intuition, emotion, and the unconscious. A day for receptivity. Let wisdom arise from within rather than seeking it without.',
                principle: 'Correspondence',
                principleHint: 'As above, so below. Your inner emotional state reflects in your outer world. Harmonize within to harmonize without.',
                affirmation: '"I am receptive to the wisdom that flows through me. My inner world shapes my outer reality."',
                element: 'Water'
            },
            2: { // Tuesday
                planet: 'Mars',
                symbol: '♂',
                title: 'Tuesday — Mars (Tyr)',
                description: 'Mars governs will, courage, and action. A day for transmuting fear into directed force. The Hermetic Warrior acts, not reacts.',
                principle: 'Polarity',
                principleHint: 'Fear and Courage are the same pole. Today, consciously raise your vibration from hesitation to decisive action.',
                affirmation: '"I transmute fear into focused will. I act from center, not from reaction."',
                element: 'Fire'
            },
            3: { // Wednesday  
                planet: 'Mercury',
                symbol: '☿',
                title: 'Wednesday — Mercury (Hermes)',
                description: 'Mercury governs communication, intellect, and the transmission of wisdom. Hermes himself rules this day. A day for study, learning, and teaching.',
                principle: 'Vibration',
                principleHint: 'Everything vibrates. Your words carry frequency. Speak truth. Let your communication raise the vibration of all it touches.',
                affirmation: '"I am a clear channel for wisdom. My words carry the frequency of truth."',
                element: 'Air'
            },
            4: { // Thursday
                planet: 'Jupiter',
                symbol: '♃',
                title: 'Thursday — Jupiter (Thor/Zeus)',
                description: 'Jupiter governs expansion, abundance, and higher law. A day to align with universal order. The macrocosm supports your growth.',
                principle: 'Cause & Effect',
                principleHint: 'Every cause has its effect. Today, plant seeds deliberately. Align your actions with the effects you wish to harvest.',
                affirmation: '"I am a cause, not an effect. I plant seeds in alignment with universal law."',
                element: 'Air/Fire'
            },
            5: { // Friday
                planet: 'Venus',
                symbol: '♀',
                title: 'Friday — Venus (Freya)',
                description: 'Venus governs love, beauty, harmony, and union. A day for appreciating the divine in form. The material world is sacred when seen correctly.',
                principle: 'Gender',
                principleHint: 'Masculine and Feminine unite in all creation. Today, balance giving and receiving, will and surrender.',
                affirmation: '"I embrace both poles within me. I create through the union of will and receptivity."',
                element: 'Water/Earth'
            },
            6: { // Saturday
                planet: 'Saturn',
                symbol: '♄',
                title: 'Saturday — Saturn (Chronos)',
                description: 'Saturn governs time, discipline, structure, and the boundaries of form. The final sphere before the stars. A day for reflection on what is essential.',
                principle: 'Rhythm',
                principleHint: 'All things have their tides. Saturn knows the value of the low swing. Rest is not failure — it is the gathering before the leap.',
                affirmation: '"I honor the rhythm of expansion and contraction. In stillness, I gather power."',
                element: 'Earth'
            }
        };

        function getMoonPhase() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            const day = now.getDate();

            // Simplified moon phase calculation (based on lunar cycle ~29.5 days)
            const totalDays = (year - 2000) * 365.25 + (month - 1) * 30.6 + day;
            const lunarCycle = 29.53;
            const phase = ((totalDays % lunarCycle) / lunarCycle) * 8;

            const phases = [
                { icon: '🌑', name: 'New Moon — Planting Seeds', energy: 'Beginnings, intentions, the void before creation' },
                { icon: '🌒', name: 'Waxing Crescent — Emerging', energy: 'First stirrings, hope, building momentum' },
                { icon: '🌓', name: 'First Quarter — Building', energy: 'Challenges, action required, overcoming' },
                { icon: '🌔', name: 'Waxing Gibbous — Refining', energy: 'Adjusting, patience, almost there' },
                { icon: '🌕', name: 'Full Moon — Illumination', energy: 'Peak power, manifestation, clarity' },
                { icon: '🌖', name: 'Waning Gibbous — Gratitude', energy: 'Receiving, sharing, abundance' },
                { icon: '🌗', name: 'Last Quarter — Releasing', energy: 'Letting go, forgiveness, clearing' },
                { icon: '🌘', name: 'Waning Crescent — Surrender', energy: 'Rest, introspection, preparing for renewal' }
            ];

            return phases[Math.floor(phase)];
        }

        function updateDailyRitual() {
            const dayOfWeek = new Date().getDay();
            const data = planetaryData[dayOfWeek];
            const moon = getMoonPhase();

            document.getElementById('ritual-planet-symbol').textContent = data.symbol;
            document.getElementById('ritual-day-title').textContent = data.title;
            document.getElementById('ritual-day-description').textContent = data.description;
            document.getElementById('ritual-moon-icon').textContent = moon.icon;
            document.getElementById('ritual-moon-phase').textContent = moon.name;
            document.getElementById('ritual-principle').textContent = data.principle;
            document.getElementById('ritual-principle-hint').textContent = data.principleHint;
            document.getElementById('ritual-affirmation').textContent = data.affirmation;
        }

        // ===== ORACLE SPREAD =====

        const romanNumerals = ['I', 'II', 'III', 'IV', 'V', 'VI', 'VII'];
        const principleNames = ['Mentalism', 'Correspondence', 'Vibration', 'Polarity', 'Rhythm', 'Cause & Effect', 'Gender'];

        let oracleDrawn = [null, null, null];
        let cardsFlipped = [false, false, false];

        // Synthesis messages based on principle combinations
        const synthesesData = {
            // Format: "principle1-principle2-principle3" : "synthesis message"
            // Some key combinations with meaningful insights
            default: [
                "The three principles you've drawn form a unique constellation for this moment. Contemplate how they weave together in your current circumstances.",
                "These principles speak to the Unity beneath apparent diversity. What pattern do you see emerging?",
                "The Oracle reveals what your higher Self already knows. Let the synthesis arise from your own contemplation.",
                "In the Hermetic view, all principles ultimately express The One. How do these three reflect aspects of your wholeness?",
                "What was, what is, and what can be — all exist Now in the eternal present. These principles are not separate from you."
            ]
        };

        function generateSynthesis(p1, p2, p3) {
            // Some specific meaningful combinations
            const combos = {
                '0-3-6': 'Mind perceives duality, which gives birth to creation. You are learning to think past polarities into the creative unity beyond.',
                '1-4-5': 'As above, so below — through rhythmic cycles, cause becomes effect. You are seeing how patterns repeat across scales of time.',
                '2-3-4': 'Vibration modulates between poles in rhythmic waves. You are being called to ride the wave rather than fight the current.',
                '0-1-2': 'All is Mind, reflected in correspondence, expressed as vibration. You are awakening to the mental nature of your experience.',
                '4-5-6': 'Rhythm, Causation, and Gender — the principles of manifestation. You are in a creative cycle. What are you bringing into form?',
                '0-5-6': 'Mind as cause, expressed through the union of polarities. You are being shown your creative power and responsibility.',
                '1-2-3': 'Correspondence through vibration along the poles. You are tuning your inner frequency to reshape your outer world.',
                '3-4-5': 'Polarity swings in rhythm, creating effects. You are learning to neutralize emotional extremes through understanding.',
            };

            const key = `${p1}-${p2}-${p3}`;
            if (combos[key]) return combos[key];

            // Generate a meaningful synthesis based on principles
            const meanings = {
                0: 'the mental origin of reality',
                1: 'the reflection between inner and outer worlds',
                2: 'the vibrational nature of all things',
                3: 'the dance of opposites',
                4: 'the rhythmic flow of existence',
                5: 'the law of sowing and reaping',
                6: 'the creative union of polarities'
            };

            return `Your spread reveals ${meanings[p1]}, moving through ${meanings[p2]}, toward ${meanings[p3]}. This is your current arc of becoming.`;
        }

        function drawOracleSpread() {
            // Reset cards
            cardsFlipped = [false, false, false];
            document.querySelectorAll('.oracle-card').forEach(card => card.classList.remove('flipped'));
            document.getElementById('oracle-synthesis').classList.add('hidden');

            // Draw 3 unique principles
            const available = [0, 1, 2, 3, 4, 5, 6];
            oracleDrawn = [];

            for (let i = 0; i < 3; i++) {
                const randomIndex = Math.floor(Math.random() * available.length);
                oracleDrawn.push(available[randomIndex]);
                available.splice(randomIndex, 1);
            }

            // Update card content
            oracleDrawn.forEach((principleIndex, cardIndex) => {
                document.getElementById(`oracle-num-${cardIndex}`).textContent = romanNumerals[principleIndex];
                document.getElementById(`oracle-title-${cardIndex}`).textContent = principleNames[principleIndex];
            });

            // Change button text
            document.getElementById('oracle-draw-btn').textContent = '✦ Tap Cards to Reveal ✦';
        }

        function flipOracleCard(cardIndex) {
            if (cardsFlipped[cardIndex]) return;

            const card = document.getElementById(`oracle-card-${cardIndex}`);
            card.classList.add('flipped');
            cardsFlipped[cardIndex] = true;

            // Check if all cards are flipped
            if (cardsFlipped.every(f => f)) {
                showOracleSynthesis();
            }
        }

        function showOracleSynthesis() {
            const synthesisEl = document.getElementById('oracle-synthesis');
            const synthesisText = document.getElementById('oracle-synthesis-text');

            synthesisText.textContent = generateSynthesis(oracleDrawn[0], oracleDrawn[1], oracleDrawn[2]);

            synthesisEl.classList.remove('hidden');
            synthesisEl.classList.add('oracle-synthesis');

            // Update button
            document.getElementById('oracle-draw-btn').textContent = '✦ Draw New Spread ✦';

            // Scroll to synthesis
            setTimeout(() => {
                synthesisEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
        }

        // ===== EMERALD CONTEMPLATION =====

        let contemplationDuration = 420; // 7 minutes default
        let contemplationTimer = null;
        let contemplationRemaining = 0;

        const fullVerses = [
            '"Tis true without lying, certain and most true: That which is below is like that which is above, and that which is above is like that which is below, to accomplish the miracle of the One Thing."',
            '"That which is below is like that which is above, and that which is above is like that which is below, to accomplish the miracles of the One Thing."',
            '"And as all things have been and arose from One by the mediation of One, so all things have their birth from this One Thing by adaptation."',
            '"The Sun is its father, the Moon its mother, the Wind hath carried it in its belly, the Earth is its nurse."',
            '"Separate thou the Earth from the Fire, the subtle from the gross, sweetly with great industry."',
            '"Its force or power is entire if it be converted into Earth."'
        ];

        function setContemplationDuration(seconds, btn) {
            contemplationDuration = seconds;
            document.querySelectorAll('.duration-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function enterContemplation() {
            const verseIndex = document.getElementById('contemplation-verse-select').value;
            document.getElementById('contemplation-verse-display').textContent = fullVerses[verseIndex];

            contemplationRemaining = contemplationDuration;
            updateTimerDisplay();

            document.getElementById('contemplation-overlay').classList.add('active');
            document.body.style.overflow = 'hidden';

            // Start timer
            contemplationTimer = setInterval(() => {
                contemplationRemaining--;
                updateTimerDisplay();

                if (contemplationRemaining <= 0) {
                    clearInterval(contemplationTimer);
                    // Pulse the complete button
                    document.querySelector('.contemplation-content button').style.boxShadow = '0 0 30px rgba(214, 158, 46, 0.5)';
                }
            }, 1000);

            // Update progress ring rotation
            updateTimerProgress();
        }

        function exitContemplation() {
            if (contemplationTimer) {
                clearInterval(contemplationTimer);
            }

            document.getElementById('contemplation-overlay').classList.remove('active');
            document.body.style.overflow = '';

            // Save journal entry to localStorage if content exists
            const journal = document.getElementById('contemplation-journal');
            if (journal.value.trim()) {
                const entries = JSON.parse(localStorage.getItem('hermetic-journal') || '[]');
                entries.push({
                    date: new Date().toISOString(),
                    verse: document.getElementById('contemplation-verse-display').textContent,
                    insight: journal.value.trim()
                });
                localStorage.setItem('hermetic-journal', JSON.stringify(entries));
                journal.value = '';
            }
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(contemplationRemaining / 60);
            const seconds = contemplationRemaining % 60;
            document.getElementById('timer-display').textContent =
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateTimerProgress() {
            const progress = document.getElementById('timer-progress');
            const totalRotation = 360;

            const update = () => {
                if (contemplationRemaining <= 0) return;

                const elapsed = contemplationDuration - contemplationRemaining;
                const rotation = (elapsed / contemplationDuration) * totalRotation;
                progress.style.transform = `rotate(${rotation}deg)`;

                requestAnimationFrame(update);
            };

            update();
        }

        // Update init to include new features
        const originalInit = init;
        init = function () {
            originalInit();
            updateDailyRitual();
        };

    </script>

    <!-- ORACLE SECTION -->
    <section id="oracle-section" class="py-20 px-6 max-w-5xl mx-auto border-t border-themed bg-bg-tertiary">
        <div class="text-center mb-12 fade-in">
            <span class="text-accent-gold font-bold tracking-wider text-sm uppercase">Hermetic Divination</span>
            <h2 class="text-3xl md:text-4xl font-serif font-bold mt-2 mb-4">The Oracle of Principles</h2>
            <div class="h-1 w-20 bg-accent-gold mx-auto mb-6"></div>
            <p class="text-themed-secondary max-w-2xl mx-auto">
                Consult the seven principles. Draw a triad of wisdom to guide your current path.
                Focus your mind on a question, then reveal the cards.
            </p>
        </div>

        <!-- Oracle Cards Container -->
        <div class="flex flex-col md:flex-row justify-center items-center gap-8 mb-12">
            <!-- Card 1 -->
            <div id="oracle-card-0" onclick="flipOracleCard(0)"
                class="oracle-card w-48 h-72 relative cursor-pointer perspective-1000 group">
                <div class="card-inner relative w-full h-full transition-transform duration-700 transform-style-3d">
                    <div
                        class="card-front absolute inset-0 bg-gray-800 rounded-xl border-2 border-amber-600/50 flex items-center justify-center backface-hidden shadow-lg group-hover:shadow-glow">
                        <span class="text-4xl text-amber-500/50">✦</span>
                    </div>
                    <div
                        class="card-back absolute inset-0 bg-bg-secondary rounded-xl border-2 border-accent-gold flex flex-col items-center justify-center p-4 backface-hidden rotate-y-180 shadow-glow">
                        <span id="oracle-num-0" class="text-accent-gold font-serif text-lg mb-2">I</span>
                        <h3 id="oracle-title-0" class="text-xl font-bold text-center mb-2">Mentalism</h3>
                    </div>
                </div>
            </div>
            <!-- Card 2 -->
            <div id="oracle-card-1" onclick="flipOracleCard(1)"
                class="oracle-card w-48 h-72 relative cursor-pointer perspective-1000 group">
                <div class="card-inner relative w-full h-full transition-transform duration-700 transform-style-3d">
                    <div
                        class="card-front absolute inset-0 bg-gray-800 rounded-xl border-2 border-amber-600/50 flex items-center justify-center backface-hidden shadow-lg group-hover:shadow-glow">
                        <span class="text-4xl text-amber-500/50">✦</span>
                    </div>
                    <div
                        class="card-back absolute inset-0 bg-bg-secondary rounded-xl border-2 border-accent-gold flex flex-col items-center justify-center p-4 backface-hidden rotate-y-180 shadow-glow">
                        <span id="oracle-num-1" class="text-accent-gold font-serif text-lg mb-2">II</span>
                        <h3 id="oracle-title-1" class="text-xl font-bold text-center mb-2">Correspondence</h3>
                    </div>
                </div>
            </div>
            <!-- Card 3 -->
            <div id="oracle-card-2" onclick="flipOracleCard(2)"
                class="oracle-card w-48 h-72 relative cursor-pointer perspective-1000 group">
                <div class="card-inner relative w-full h-full transition-transform duration-700 transform-style-3d">
                    <div
                        class="card-front absolute inset-0 bg-gray-800 rounded-xl border-2 border-amber-600/50 flex items-center justify-center backface-hidden shadow-lg group-hover:shadow-glow">
                        <span class="text-4xl text-amber-500/50">✦</span>
                    </div>
                    <div
                        class="card-back absolute inset-0 bg-bg-secondary rounded-xl border-2 border-accent-gold flex flex-col items-center justify-center p-4 backface-hidden rotate-y-180 shadow-glow">
                        <span id="oracle-num-2" class="text-accent-gold font-serif text-lg mb-2">III</span>
                        <h3 id="oracle-title-2" class="text-xl font-bold text-center mb-2">Vibration</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Synthesis & Controls -->
        <div class="text-center">
            <div id="oracle-synthesis"
                class="hidden mb-8 max-w-2xl mx-auto p-6 bg-bg-secondary rounded-xl border border-accent-gold/30 fade-in">
                <h4 class="text-accent-gold font-serif font-bold mb-2">Hermetic Synthesis</h4>
                <p id="oracle-synthesis-text" class="text-lg italic leading-relaxed">
                    The cards reveal...
                </p>
            </div>

            <button id="oracle-draw-btn" onclick="drawOracleSpread()"
                class="px-8 py-3 rounded-full bg-gradient-to-r from-amber-600 to-amber-700 text-white font-bold shadow-lg hover:shadow-glow hover:-translate-y-1 transition-all">
                ✦ Draw New Spread ✦
            </button>
        </div>
    </section>

    <!-- LIBRARY ARCHIVES SECTION -->
    <section id="archives-section" class="py-20 px-6 max-w-6xl mx-auto border-t border-themed">
        <div class="text-center mb-12 fade-in">
            <span class="text-accent-gold font-bold tracking-wider text-sm uppercase">The Sacred Library</span>
            <h2 class="text-3xl md:text-4xl font-serif font-bold mt-2 mb-4">Wisdom Archives</h2>
            <div class="h-1 w-20 bg-accent-gold mx-auto mb-6"></div>
            <p class="text-themed-secondary max-w-2xl mx-auto">
                Access foundational texts from Hermetic, Zoroastrian, and African wisdom traditions.
                Search within texts, analyze word frequency, and take notes.
            </p>
        </div>

        <!-- Category Filter -->
        <div class="flex flex-wrap justify-center gap-2 mb-10" id="category-filters">
            <button onclick="filterByCategory('all')"
                class="category-btn active px-4 py-2 rounded-full text-sm font-medium transition-all"
                data-category="all">
                📚 All Texts
            </button>
            <button onclick="filterByCategory('hermetic')"
                class="category-btn px-4 py-2 rounded-full text-sm font-medium transition-all" data-category="hermetic">
                ⚗️ Hermetic
            </button>
            <button onclick="filterByCategory('zoroastrian')"
                class="category-btn px-4 py-2 rounded-full text-sm font-medium transition-all"
                data-category="zoroastrian">
                🔥 Zoroastrian
            </button>
            <button onclick="filterByCategory('african')"
                class="category-btn px-4 py-2 rounded-full text-sm font-medium transition-all" data-category="african">
                🌍 African Wisdom
            </button>
        </div>

        <!-- Dynamic Library Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="library-grid">
            <!-- Cards injected via JS -->
        </div>

        <!-- Distill Button -->
        <div class="text-center mt-12">
            <button onclick="distillWisdom()"
                class="px-8 py-3 rounded-full bg-gradient-to-r from-amber-600 to-amber-700 text-white font-bold shadow-lg hover:shadow-glow hover:-translate-y-1 transition-all">
                ✦ Distill Random Wisdom ✦
            </button>
        </div>
    </section>

    <!-- READER OVERLAY MODAL -->
    <div id="reader-overlay"
        class="fixed inset-0 z-50 bg-bg-primary/95 backdrop-blur-md transition-opacity duration-300 opacity-0 pointer-events-none flex flex-col"
        style="transition: opacity 0.3s;">
        <style>
            #reader-overlay.active {
                opacity: 1;
                pointer-events: auto;
            }

            .reader-panel {
                display: none;
            }

            .reader-panel.active {
                display: block;
            }

            .panel-tab.active {
                background: var(--accent-gold);
                color: white;
            }

            .search-highlight {
                background: rgba(214, 158, 46, 0.3);
                border-radius: 2px;
                padding: 0 2px;
            }

            .search-highlight.current {
                background: rgba(214, 158, 46, 0.6);
            }
        </style>

        <!-- Reading Progress Bar -->
        <div id="reading-progress-bar" class="h-1 bg-accent-gold/30 fixed top-0 left-0 right-0 z-20">
            <div id="reading-progress-fill" class="h-full bg-accent-gold transition-all duration-150"
                style="width: 0%;"></div>
        </div>

        <!-- Reader Header -->
        <div
            class="flex items-center justify-between p-4 border-b border-themed bg-bg-secondary/80 backdrop-blur-md sticky top-0 z-10 mt-1">
            <div class="flex items-center gap-4">
                <button onclick="closeReader()" class="p-2 rounded-full hover:bg-bg-tertiary transition-colors">
                    <svg class="w-6 h-6 text-themed-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
                <div>
                    <h2 id="reader-title" class="font-serif font-bold text-lg leading-tight">Book Title</h2>
                    <p id="reader-author" class="text-xs text-themed-muted uppercase tracking-wider">Author</p>
                </div>
            </div>
            <div class="flex gap-2 items-center">
                <!-- Font Size Controls -->
                <div class="flex items-center gap-1 mr-2 border-r border-themed pr-3">
                    <button onclick="adjustFontSize(-1)"
                        class="p-2 rounded hover:bg-bg-tertiary transition-colors text-xs font-bold"
                        title="Decrease font size">A-</button>
                    <button onclick="adjustFontSize(1)"
                        class="p-2 rounded hover:bg-bg-tertiary transition-colors text-base font-bold"
                        title="Increase font size">A+</button>
                </div>
                <button onclick="toggleReaderPanel('chapters')"
                    class="panel-tab px-3 py-2 text-xs font-bold uppercase tracking-wide border border-themed rounded-lg hover:bg-bg-tertiary transition-colors"
                    data-panel="chapters">
                    📖 Chapters
                </button>
                <button onclick="toggleReaderPanel('search')"
                    class="panel-tab px-3 py-2 text-xs font-bold uppercase tracking-wide border border-themed rounded-lg hover:bg-bg-tertiary transition-colors"
                    data-panel="search">
                    🔍 Search
                </button>
                <button onclick="toggleReaderPanel('analysis')"
                    class="panel-tab px-3 py-2 text-xs font-bold uppercase tracking-wide border border-themed rounded-lg hover:bg-bg-tertiary transition-colors"
                    data-panel="analysis">
                    📊 Analysis
                </button>
                <button onclick="toggleReaderPanel('notes')"
                    class="panel-tab px-3 py-2 text-xs font-bold uppercase tracking-wide border border-themed rounded-lg hover:bg-bg-tertiary transition-colors"
                    data-panel="notes">
                    📝 Notes
                </button>
            </div>
        </div>

        <!-- Reader Main Area -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Reader Content -->
            <div id="reader-content" class="flex-1 overflow-y-auto p-6 md:p-12 max-w-3xl mx-auto w-full custom-scroll">
                <!-- Content injected via JS -->
            </div>

            <!-- Sidebar Panels -->
            <div id="reader-sidebar"
                class="w-80 border-l border-themed bg-bg-secondary hidden md:block overflow-y-auto">
                <!-- Chapters Panel -->
                <div id="chapters-panel" class="reader-panel p-4">
                    <h3 class="font-bold mb-3">📖 Chapters</h3>
                    <div id="chapters-list" class="space-y-1">
                        <!-- Chapters dynamically injected -->
                    </div>
                </div>
                <!-- Search Panel -->
                <div id="search-panel" class="reader-panel p-4">
                    <h3 class="font-bold mb-3">Search in Text</h3>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="reader-search-input" placeholder="Search..."
                            class="flex-1 px-3 py-2 bg-bg-tertiary border border-themed rounded-lg text-sm focus:outline-none focus:border-accent-gold"
                            onkeyup="handleReaderSearch(event)">
                        <button onclick="executeReaderSearch()"
                            class="px-3 py-2 bg-accent-gold text-white rounded-lg text-sm font-bold">
                            Go
                        </button>
                    </div>
                    <div id="search-results" class="text-sm text-themed-secondary">
                        <!-- Search results will appear here -->
                    </div>
                    <div id="search-nav" class="flex gap-2 mt-4 hidden">
                        <button onclick="navigateSearch('prev')" class="px-3 py-1 bg-bg-tertiary rounded text-sm">←
                            Prev</button>
                        <span id="search-position" class="text-sm text-themed-muted py-1">0/0</span>
                        <button onclick="navigateSearch('next')" class="px-3 py-1 bg-bg-tertiary rounded text-sm">Next
                            →</button>
                    </div>
                </div>

                <!-- Analysis Panel -->
                <div id="analysis-panel" class="reader-panel p-4">
                    <h3 class="font-bold mb-3">Text Analysis</h3>
                    <div id="analysis-stats" class="space-y-3">
                        <!-- Stats will be injected here -->
                    </div>
                    <h4 class="font-bold mt-6 mb-3">Top 10 Words</h4>
                    <div id="analysis-words" class="space-y-2">
                        <!-- Top words will be injected here -->
                    </div>
                </div>

                <!-- Notes Panel -->
                <div id="notes-panel" class="reader-panel p-4">
                    <h3 class="font-bold mb-3">Your Notes</h3>
                    <textarea id="note-input" placeholder="Write your thoughts..."
                        class="w-full h-24 px-3 py-2 bg-bg-tertiary border border-themed rounded-lg text-sm resize-none focus:outline-none focus:border-accent-gold mb-3"></textarea>
                    <button onclick="saveCurrentNote()"
                        class="w-full px-4 py-2 bg-accent-gold text-white rounded-lg text-sm font-bold mb-4">
                        Save Note
                    </button>
                    <div id="notes-list" class="space-y-3">
                        <!-- Saved notes will appear here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- DISTILLATION MODAL -->
    <div id="distillation-modal"
        class="fixed inset-0 z-[60] bg-bg-primary/95 backdrop-blur-md transition-opacity duration-300 opacity-0 pointer-events-none flex items-center justify-center p-6">
        <div class="relative max-w-2xl w-full bg-bg-secondary border border-themed rounded-xl shadow-2xl p-8 md:p-10 transform transition-all duration-300 scale-95"
            id="distillation-content">
            <button onclick="closeDistillation()"
                class="absolute top-4 right-4 p-2 rounded-full hover:bg-bg-tertiary transition-colors">
                <svg class="w-6 h-6 text-themed-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>

            <div class="text-center">
                <div class="inline-block mb-6">
                    <span class="text-4xl">✨</span>
                </div>
                <h3 class="text-accent-gold font-bold tracking-wider text-sm uppercase mb-6">Wisdom Distilled</h3>

                <blockquote class="font-serif text-xl md:text-2xl italic leading-relaxed text-themed mb-8">
                    "<span id="distillation-quote">...</span>"
                </blockquote>

                <cite class="not-italic text-themed-muted text-sm uppercase tracking-wide">
                    — <span id="distillation-source">Source</span>
                </cite>

                <div class="mt-10 flex justify-center gap-4">
                    <button onclick="distillWisdom()"
                        class="px-6 py-2 rounded-full border border-accent-gold text-accent-gold font-bold text-sm hover:bg-accent-gold/10 transition-colors">
                        Another
                    </button>
                    <button onclick="closeDistillation()"
                        class="px-6 py-2 rounded-full bg-themed-tertiary text-themed-secondary font-bold text-sm hover:bg-themed hover:text-themed transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- LIBRARY OF WISDOM SCRIPTS -->
    <script src="js/text_search.js"></script>
    <script src="js/word_analyzer.js"></script>
    <script src="js/notes_manager.js"></script>
    <script src="js/texts/divine_pymander.js"></script>
    <script src="js/texts/teachings_zoroaster.js"></script>
    <script src="js/texts/unkulunkulu.js"></script>
    <script src="js/texts/kybalion.js"></script>
    <script src="js/library_data.js"></script>

    <script>
        // ... (Existing scripts will be merged or this placed carefully) ...

        // ===== LIBRARY Logic =====

        // Category icons and colors
        const categoryStyles = {
            hermetic: { icon: '⚗️', color: '#d69e2e', borderColor: 'amber-500/50' },
            gnostic: { icon: '✨', color: '#9f7aea', borderColor: 'purple-500/50' },
            zoroastrian: { icon: '🔥', color: '#ed8936', borderColor: 'orange-500/50' },
            african: { icon: '🌍', color: '#48bb78', borderColor: 'green-500/50' }
        };

        // Render library grid
        function renderLibraryGrid(filter = 'all') {
            const grid = document.getElementById('library-grid');
            if (!grid || !window.libraryData) return;

            grid.innerHTML = '';

            const filteredBooks = filter === 'all'
                ? window.libraryData
                : window.libraryData.filter(b => b.category === filter);

            filteredBooks.forEach(book => {
                const style = categoryStyles[book.category] || categoryStyles.hermetic;
                const chapterCount = book.content?.length || 0;

                const card = document.createElement('div');
                card.className = 'library-card principle-card p-6 rounded-xl border border-themed cursor-pointer group transition-all hover:-translate-y-1';
                card.setAttribute('data-category', book.category);
                card.onclick = () => openBook(book.id);

                card.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div class="h-12 w-12 rounded-xl flex items-center justify-center text-2xl" 
                             style="background: ${style.color}15;">
                            ${style.icon}
                        </div>
                        <span class="text-xs font-medium px-2 py-1 rounded-full" 
                              style="background: ${style.color}20; color: ${style.color};">
                            ${book.category}
                        </span>
                    </div>
                    <h3 class="text-lg font-bold mb-1 font-serif group-hover:text-amber-500 transition-colors">${book.title}</h3>
                    <p class="text-sm text-themed-muted mb-3">${book.author}</p>
                    <p class="text-sm text-themed-secondary mb-4 line-clamp-2">${book.description}</p>
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-themed-muted">${chapterCount} chapters</span>
                        <span class="text-sm font-bold uppercase tracking-wide group-hover:translate-x-1 transition-transform" 
                              style="color: ${style.color};">
                            Read →
                        </span>
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        // Filter by category
        function filterByCategory(category) {
            // Update active button
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.category === category) {
                    btn.classList.add('active');
                }
            });

            renderLibraryGrid(category);
        }

        function openLibrary() {
            // Show library section/modal or scroll to it
            navTo('archives-section');
        }

        // Initialize library on page load
        document.addEventListener('DOMContentLoaded', function () {
            renderLibraryGrid('all');
        });

        function openBook(bookId) {
            const book = window.libraryData.find(b => b.id === bookId);
            if (!book) return;

            // Store reference for panels
            currentReaderBook = book;

            document.getElementById('reader-title').textContent = book.title;
            document.getElementById('reader-author').textContent = book.author;

            const contentContainer = document.getElementById('reader-content');
            contentContainer.innerHTML = ''; // Clear previous

            // Render chapters with IDs for navigation
            book.content.forEach((chapter, index) => {
                const chapterEl = document.createElement('div');
                chapterEl.className = 'chapter-block mb-8';
                chapterEl.id = `chapter-${index}`;
                chapterEl.innerHTML = `
        <h3 class="text-xl font-serif font-bold text-amber-700 dark:text-amber-500 mb-4">${chapter.title}</h3>
        <div class="prose dark:prose-invert max-w-none font-serif leading-relaxed opacity-90 reader-text">
            ${chapter.text.split('\n\n').map(p => `<p class="mb-4">${p}</p>`).join('')}
        </div>
        `;
                contentContainer.appendChild(chapterEl);
            });

            // Populate chapters panel
            populateChaptersPanel(book);

            // Apply saved font size
            applyFontSize();

            document.getElementById('reader-overlay').classList.add('active');
            document.body.style.overflow = 'hidden';

            // Restore reading position after a brief delay
            setTimeout(() => {
                restoreReadingPosition(bookId);
                setupScrollTracking(bookId);
            }, 100);
        }

        function closeReader() {
            // Save reading position before closing
            if (currentReaderBook) {
                saveReadingPosition(currentReaderBook.id);
            }
            document.getElementById('reader-overlay').classList.remove('active');
            document.body.style.overflow = '';
            // Close any open panels
            document.querySelectorAll('.reader-panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
            // Reset progress bar
            document.getElementById('reading-progress-fill').style.width = '0%';
            currentReaderBook = null;
        }

        // ===== ENHANCED READER FEATURES =====
        let readerFontSize = parseInt(localStorage.getItem('readerFontSize') || '18');

        function populateChaptersPanel(book) {
            const chaptersContainer = document.getElementById('chapters-list');
            if (!chaptersContainer) return;
            chaptersContainer.innerHTML = book.content.map((chapter, index) => `
                <button onclick="scrollToChapter(${index})" 
                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-bg-tertiary text-sm transition-colors truncate chapter-nav-item"
                    data-chapter="${index}">
                    ${chapter.title}
                </button>
            `).join('');
        }

        function scrollToChapter(index) {
            const chapterEl = document.getElementById(`chapter-${index}`);
            if (chapterEl) {
                chapterEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // Highlight active chapter in nav
                document.querySelectorAll('.chapter-nav-item').forEach(el => el.classList.remove('bg-accent-gold/20'));
                document.querySelector(`[data-chapter="${index}"]`)?.classList.add('bg-accent-gold/20');
            }
        }

        function adjustFontSize(delta) {
            readerFontSize = Math.max(14, Math.min(28, readerFontSize + delta * 2));
            localStorage.setItem('readerFontSize', readerFontSize);
            applyFontSize();
        }

        function applyFontSize() {
            document.querySelectorAll('.reader-text').forEach(el => {
                el.style.fontSize = `${readerFontSize}px`;
            });
        }

        function saveReadingPosition(bookId) {
            const contentContainer = document.getElementById('reader-content');
            if (!contentContainer) return;
            const scrollPercent = (contentContainer.scrollTop / (contentContainer.scrollHeight - contentContainer.clientHeight)) * 100;
            const positions = JSON.parse(localStorage.getItem('readingPositions') || '{}');
            positions[bookId] = {
                scrollPercent: scrollPercent,
                lastRead: Date.now()
            };
            localStorage.setItem('readingPositions', JSON.stringify(positions));
        }

        function restoreReadingPosition(bookId) {
            const contentContainer = document.getElementById('reader-content');
            if (!contentContainer) return;
            const positions = JSON.parse(localStorage.getItem('readingPositions') || '{}');
            if (positions[bookId]) {
                const scrollPercent = positions[bookId].scrollPercent || 0;
                contentContainer.scrollTop = (scrollPercent / 100) * (contentContainer.scrollHeight - contentContainer.clientHeight);
            }
        }

        function setupScrollTracking(bookId) {
            const contentContainer = document.getElementById('reader-content');
            if (!contentContainer) return;

            contentContainer.addEventListener('scroll', () => {
                // Update progress bar
                const scrollPercent = (contentContainer.scrollTop / (contentContainer.scrollHeight - contentContainer.clientHeight)) * 100;
                document.getElementById('reading-progress-fill').style.width = `${Math.min(100, scrollPercent)}%`;

                // Debounced save (every 2 seconds of scrolling)
                clearTimeout(contentContainer.scrollSaveTimeout);
                contentContainer.scrollSaveTimeout = setTimeout(() => {
                    saveReadingPosition(bookId);
                }, 2000);
            });
        }

        // ===== READER PANEL FUNCTIONALITY =====
        let currentReaderBook = null;
        let textSearchEngine = null;
        let wordAnalyzer = null;
        let notesManager = null;

        function toggleReaderPanel(panelName) {
            const panel = document.getElementById(`${panelName}-panel`);
            const tabs = document.querySelectorAll('.panel-tab');
            const panels = document.querySelectorAll('.reader-panel');

            // Toggle off if already active
            if (panel.classList.contains('active')) {
                panel.classList.remove('active');
                tabs.forEach(t => t.classList.remove('active'));
                return;
            }

            // Deactivate all
            panels.forEach(p => p.classList.remove('active'));
            tabs.forEach(t => t.classList.remove('active'));

            // Activate selected
            panel.classList.add('active');
            document.querySelector(`[data-panel="${panelName}"]`).classList.add('active');

            // Initialize panel content
            if (panelName === 'analysis' && currentReaderBook) {
                runTextAnalysis();
            }
            if (panelName === 'notes' && currentReaderBook) {
                loadNotes();
            }
        }

        // Search functionality
        function handleReaderSearch(event) {
            if (event.key === 'Enter') {
                executeReaderSearch();
            }
        }

        function executeReaderSearch() {
            const query = document.getElementById('reader-search-input').value;
            if (!query || !currentReaderBook) return;

            // Get all text content
            const fullText = currentReaderBook.content.map(c => c.text).join('\n\n');

            if (!textSearchEngine) {
                textSearchEngine = new TextSearchEngine();
            }

            const results = textSearchEngine.search(fullText, query);
            const resultsContainer = document.getElementById('search-results');
            const navContainer = document.getElementById('search-nav');

            if (results.length === 0) {
                resultsContainer.innerHTML = '<p class="text-themed-muted">No results found.</p>';
                navContainer.classList.add('hidden');
                return;
            }

            resultsContainer.innerHTML = results.slice(0, 10).map((r, i) => `
                <div class="p-2 bg-bg-tertiary rounded mb-2 cursor-pointer hover:bg-accent-gold/10" onclick="scrollToSearchResult(${i})">
                    <p class="text-xs text-themed-muted">Match ${i + 1}</p>
                    <p class="text-sm">...${r.context}...</p>
                </div>
            `).join('');

            navContainer.classList.remove('hidden');
            document.getElementById('search-position').textContent = `1/${results.length}`;
        }

        function scrollToSearchResult(index) {
            // Simple scroll to highlight - could be enhanced
            const contentDiv = document.getElementById('reader-content');
            const query = document.getElementById('reader-search-input').value;

            // Clear previous highlights
            contentDiv.innerHTML = contentDiv.innerHTML.replace(/<mark class="search-highlight[^"]*">/g, '').replace(/<\/mark>/g, '');

            // Add new highlights
            const regex = new RegExp(`(${query})`, 'gi');
            contentDiv.innerHTML = contentDiv.innerHTML.replace(regex, '<mark class="search-highlight">$1</mark>');

            // Scroll to first match
            const highlight = contentDiv.querySelector('.search-highlight');
            if (highlight) {
                highlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
                highlight.classList.add('current');
            }
        }

        // Analysis functionality
        function runTextAnalysis() {
            if (!currentReaderBook) return;

            const fullText = currentReaderBook.content.map(c => c.text).join('\n\n');

            if (!wordAnalyzer) {
                wordAnalyzer = new WordAnalyzer();
            }

            const stats = wordAnalyzer.getStats(fullText);
            const topWords = wordAnalyzer.getTopWords(fullText, 10);

            document.getElementById('analysis-stats').innerHTML = `
                <div class="flex justify-between p-2 bg-bg-tertiary rounded">
                    <span class="text-themed-muted">Word Count</span>
                    <span class="font-bold">${stats.wordCount.toLocaleString()}</span>
                </div>
                <div class="flex justify-between p-2 bg-bg-tertiary rounded">
                    <span class="text-themed-muted">Chapters</span>
                    <span class="font-bold">${currentReaderBook.content.length}</span>
                </div>
                <div class="flex justify-between p-2 bg-bg-tertiary rounded">
                    <span class="text-themed-muted">Reading Time</span>
                    <span class="font-bold">${stats.readingTime} min</span>
                </div>
                <div class="flex justify-between p-2 bg-bg-tertiary rounded">
                    <span class="text-themed-muted">Unique Words</span>
                    <span class="font-bold">${stats.uniqueWords.toLocaleString()}</span>
                </div>
            `;

            document.getElementById('analysis-words').innerHTML = topWords.map((w, i) => `
                <div class="flex items-center gap-2">
                    <span class="w-6 h-6 flex items-center justify-center bg-accent-gold/20 text-accent-gold text-xs font-bold rounded">${i + 1}</span>
                    <span class="flex-1 text-sm">${w.word}</span>
                    <span class="text-xs text-themed-muted">${w.count}×</span>
                </div>
            `).join('');
        }

        // Notes functionality
        function loadNotes() {
            if (!currentReaderBook) return;

            if (!notesManager) {
                notesManager = new NotesManager();
            }

            const notes = notesManager.getNotes(currentReaderBook.id);
            const notesList = document.getElementById('notes-list');

            if (notes.length === 0) {
                notesList.innerHTML = '<p class="text-themed-muted text-sm">No notes yet. Add your first note above!</p>';
                return;
            }

            notesList.innerHTML = notes.map(note => `
                <div class="p-3 bg-bg-tertiary rounded-lg">
                    <p class="text-sm mb-2">${note.text}</p>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-themed-muted">${new Date(note.createdAt).toLocaleDateString()}</span>
                        <button onclick="deleteNote('${note.id}')" class="text-xs text-red-500 hover:text-red-400">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function saveCurrentNote() {
            if (!currentReaderBook) return;

            const input = document.getElementById('note-input');
            const text = input.value.trim();
            if (!text) return;

            if (!notesManager) {
                notesManager = new NotesManager();
            }

            notesManager.addNote(currentReaderBook.id, text);
            input.value = '';
            loadNotes();
        }

        function deleteNote(noteId) {
            if (!notesManager) return;
            notesManager.deleteNote(noteId);
            loadNotes();
        }

        // Search/Distill feature (Premium Modal)
        function distillWisdom() {
            const allBooks = window.libraryData;
            if (!allBooks || allBooks.length === 0) return;

            // Random selection
            const randomBook = allBooks[Math.floor(Math.random() * allBooks.length)];
            const randomChapter = randomBook.content[Math.floor(Math.random() * randomBook.content.length)];
            // Filter out empty paragraphs
            const paragraphs = randomChapter.text.split('\n\n').filter(p => p.trim().length > 0);
            const randomPara = paragraphs[Math.floor(Math.random() * paragraphs.length)];

            // Populate Modal
            document.getElementById('distillation-quote').textContent = randomPara;
            document.getElementById('distillation-source').textContent = randomBook.title;

            // Show Modal
            const modal = document.getElementById('distillation-modal');
            const content = document.getElementById('distillation-content');

            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100', 'pointer-events-auto');

            // Animate content scale
            setTimeout(() => {
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);

            document.body.style.overflow = 'hidden';
        }

        function closeDistillation() {
            const modal = document.getElementById('distillation-modal');
            const content = document.getElementById('distillation-content');

            modal.classList.remove('opacity-100', 'pointer-events-auto');
            modal.classList.add('opacity-0', 'pointer-events-none');

            content.classList.remove('scale-100');
            content.classList.add('scale-95');

            document.body.style.overflow = '';
        }
    </script>
</body>


</html>